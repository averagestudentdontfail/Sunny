<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kiran K. Nath">
<meta name="dcterms.date" content="2026-09-06">
<meta name="keywords" content="Volatility Risk Premium, Earnings Announcements, Calendar Spreads, Algorithmic Trading, Options Strategies, Yang-Zhang Estimator">

<title>The Sunny Algorithm: A Systematic Framework for Harvesting the Earnings Volatility Risk Premium Through Calendar Spreads</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Sunny_files/libs/clipboard/clipboard.min.js"></script>
<script src="Sunny_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Sunny_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Sunny_files/libs/quarto-html/popper.min.js"></script>
<script src="Sunny_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Sunny_files/libs/quarto-html/anchor.min.js"></script>
<link href="Sunny_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Sunny_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Sunny_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Sunny_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Sunny_files/libs/bootstrap/bootstrap-cc9d11020b29250a0c2b1331101ea711.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#literature-review-and-theoretical-foundation" id="toc-literature-review-and-theoretical-foundation" class="nav-link" data-scroll-target="#literature-review-and-theoretical-foundation"><span class="header-section-number">2</span> Literature Review and Theoretical Foundation</a></li>
  <li><a href="#mathematical-framework-and-signal-generation" id="toc-mathematical-framework-and-signal-generation" class="nav-link" data-scroll-target="#mathematical-framework-and-signal-generation"><span class="header-section-number">3</span> Mathematical Framework and Signal Generation</a>
  <ul class="collapse">
  <li><a href="#the-yang-zhang-realized-volatility-estimator" id="toc-the-yang-zhang-realized-volatility-estimator" class="nav-link" data-scroll-target="#the-yang-zhang-realized-volatility-estimator"><span class="header-section-number">3.1</span> The Yang-Zhang Realized Volatility Estimator</a></li>
  <li><a href="#implied-volatility-term-structure-analysis" id="toc-implied-volatility-term-structure-analysis" class="nav-link" data-scroll-target="#implied-volatility-term-structure-analysis"><span class="header-section-number">3.2</span> Implied Volatility Term Structure Analysis</a></li>
  <li><a href="#the-ivrv-ratio-signal" id="toc-the-ivrv-ratio-signal" class="nav-link" data-scroll-target="#the-ivrv-ratio-signal"><span class="header-section-number">3.3</span> The IV/RV Ratio Signal</a></li>
  <li><a href="#multi-factor-signal-integration" id="toc-multi-factor-signal-integration" class="nav-link" data-scroll-target="#multi-factor-signal-integration"><span class="header-section-number">3.4</span> Multi-Factor Signal Integration</a></li>
  </ul></li>
  <li><a href="#calendar-spread-strategy-implementation" id="toc-calendar-spread-strategy-implementation" class="nav-link" data-scroll-target="#calendar-spread-strategy-implementation"><span class="header-section-number">4</span> Calendar Spread Strategy Implementation</a>
  <ul class="collapse">
  <li><a href="#calendar-spread-mathematics-and-payoff-analysis" id="toc-calendar-spread-mathematics-and-payoff-analysis" class="nav-link" data-scroll-target="#calendar-spread-mathematics-and-payoff-analysis"><span class="header-section-number">4.1</span> Calendar Spread Mathematics and Payoff Analysis</a></li>
  <li><a href="#forward-volatility-framework" id="toc-forward-volatility-framework" class="nav-link" data-scroll-target="#forward-volatility-framework"><span class="header-section-number">4.2</span> Forward Volatility Framework</a></li>
  <li><a href="#greeks-analysis-and-risk-decomposition" id="toc-greeks-analysis-and-risk-decomposition" class="nav-link" data-scroll-target="#greeks-analysis-and-risk-decomposition"><span class="header-section-number">4.3</span> Greeks Analysis and Risk Decomposition</a></li>
  <li><a href="#optimal-strike-selection-and-timing" id="toc-optimal-strike-selection-and-timing" class="nav-link" data-scroll-target="#optimal-strike-selection-and-timing"><span class="header-section-number">4.4</span> Optimal Strike Selection and Timing</a></li>
  </ul></li>
  <li><a href="#position-sizing-and-risk-management" id="toc-position-sizing-and-risk-management" class="nav-link" data-scroll-target="#position-sizing-and-risk-management"><span class="header-section-number">5</span> Position Sizing and Risk Management</a>
  <ul class="collapse">
  <li><a href="#kelly-criterion-foundation-and-modifications" id="toc-kelly-criterion-foundation-and-modifications" class="nav-link" data-scroll-target="#kelly-criterion-foundation-and-modifications"><span class="header-section-number">5.1</span> Kelly Criterion Foundation and Modifications</a></li>
  <li><a href="#fixed-fractional-position-sizing-implementation" id="toc-fixed-fractional-position-sizing-implementation" class="nav-link" data-scroll-target="#fixed-fractional-position-sizing-implementation"><span class="header-section-number">5.2</span> Fixed Fractional Position Sizing Implementation</a></li>
  <li><a href="#portfolio-level-risk-controls" id="toc-portfolio-level-risk-controls" class="nav-link" data-scroll-target="#portfolio-level-risk-controls"><span class="header-section-number">5.3</span> Portfolio-Level Risk Controls</a></li>
  <li><a href="#dynamic-risk-monitoring-and-position-management" id="toc-dynamic-risk-monitoring-and-position-management" class="nav-link" data-scroll-target="#dynamic-risk-monitoring-and-position-management"><span class="header-section-number">5.4</span> Dynamic Risk Monitoring and Position Management</a></li>
  <li><a href="#stress-testing-and-scenario-analysis" id="toc-stress-testing-and-scenario-analysis" class="nav-link" data-scroll-target="#stress-testing-and-scenario-analysis"><span class="header-section-number">5.5</span> Stress Testing and Scenario Analysis</a></li>
  </ul></li>
  <li><a href="#empirical-implementation-and-backtesting-framework" id="toc-empirical-implementation-and-backtesting-framework" class="nav-link" data-scroll-target="#empirical-implementation-and-backtesting-framework"><span class="header-section-number">6</span> Empirical Implementation and Backtesting Framework</a>
  <ul class="collapse">
  <li><a href="#data-requirements-and-quality-assurance" id="toc-data-requirements-and-quality-assurance" class="nav-link" data-scroll-target="#data-requirements-and-quality-assurance"><span class="header-section-number">6.1</span> Data Requirements and Quality Assurance</a></li>
  <li><a href="#execution-modeling-and-transaction-costs" id="toc-execution-modeling-and-transaction-costs" class="nav-link" data-scroll-target="#execution-modeling-and-transaction-costs"><span class="header-section-number">6.2</span> Execution Modeling and Transaction Costs</a></li>
  <li><a href="#performance-evaluation-metrics" id="toc-performance-evaluation-metrics" class="nav-link" data-scroll-target="#performance-evaluation-metrics"><span class="header-section-number">6.3</span> Performance Evaluation Metrics</a></li>
  <li><a href="#statistical-validation-and-robustness-testing" id="toc-statistical-validation-and-robustness-testing" class="nav-link" data-scroll-target="#statistical-validation-and-robustness-testing"><span class="header-section-number">6.4</span> Statistical Validation and Robustness Testing</a></li>
  </ul></li>
  <li><a href="#advanced-risk-management-protocols" id="toc-advanced-risk-management-protocols" class="nav-link" data-scroll-target="#advanced-risk-management-protocols"><span class="header-section-number">7</span> Advanced Risk Management Protocols</a>
  <ul class="collapse">
  <li><a href="#multi-dimensional-risk-decomposition" id="toc-multi-dimensional-risk-decomposition" class="nav-link" data-scroll-target="#multi-dimensional-risk-decomposition"><span class="header-section-number">7.1</span> Multi-Dimensional Risk Decomposition</a></li>
  <li><a href="#dynamic-hedging-and-exposure-management" id="toc-dynamic-hedging-and-exposure-management" class="nav-link" data-scroll-target="#dynamic-hedging-and-exposure-management"><span class="header-section-number">7.2</span> Dynamic Hedging and Exposure Management</a></li>
  <li><a href="#systematic-stop-loss-and-profit-taking" id="toc-systematic-stop-loss-and-profit-taking" class="nav-link" data-scroll-target="#systematic-stop-loss-and-profit-taking"><span class="header-section-number">7.3</span> Systematic Stop-Loss and Profit-Taking</a></li>
  <li><a href="#stress-testing-and-tail-risk-management" id="toc-stress-testing-and-tail-risk-management" class="nav-link" data-scroll-target="#stress-testing-and-tail-risk-management"><span class="header-section-number">7.4</span> Stress Testing and Tail Risk Management</a></li>
  <li><a href="#regulatory-and-operational-risk-considerations" id="toc-regulatory-and-operational-risk-considerations" class="nav-link" data-scroll-target="#regulatory-and-operational-risk-considerations"><span class="header-section-number">7.5</span> Regulatory and Operational Risk Considerations</a></li>
  </ul></li>
  <li><a href="#results-analysis-and-performance-attribution" id="toc-results-analysis-and-performance-attribution" class="nav-link" data-scroll-target="#results-analysis-and-performance-attribution"><span class="header-section-number">8</span> Results Analysis and Performance Attribution</a>
  <ul class="collapse">
  <li><a href="#historical-performance-metrics" id="toc-historical-performance-metrics" class="nav-link" data-scroll-target="#historical-performance-metrics"><span class="header-section-number">8.1</span> Historical Performance Metrics</a></li>
  <li><a href="#factor-attribution-and-risk-decomposition" id="toc-factor-attribution-and-risk-decomposition" class="nav-link" data-scroll-target="#factor-attribution-and-risk-decomposition"><span class="header-section-number">8.2</span> Factor Attribution and Risk Decomposition</a></li>
  <li><a href="#trade-level-analysis-and-pattern-recognition" id="toc-trade-level-analysis-and-pattern-recognition" class="nav-link" data-scroll-target="#trade-level-analysis-and-pattern-recognition"><span class="header-section-number">8.3</span> Trade-Level Analysis and Pattern Recognition</a></li>
  <li><a href="#benchmark-comparison-and-relative-performance" id="toc-benchmark-comparison-and-relative-performance" class="nav-link" data-scroll-target="#benchmark-comparison-and-relative-performance"><span class="header-section-number">8.4</span> Benchmark Comparison and Relative Performance</a></li>
  <li><a href="#statistical-significance-and-robustness-validation" id="toc-statistical-significance-and-robustness-validation" class="nav-link" data-scroll-target="#statistical-significance-and-robustness-validation"><span class="header-section-number">8.5</span> Statistical Significance and Robustness Validation</a></li>
  </ul></li>
  <li><a href="#advanced-theoretical-extensions-and-future-developments" id="toc-advanced-theoretical-extensions-and-future-developments" class="nav-link" data-scroll-target="#advanced-theoretical-extensions-and-future-developments"><span class="header-section-number">9</span> Advanced Theoretical Extensions and Future Developments</a>
  <ul class="collapse">
  <li><a href="#machine-learning-integration-and-adaptive-optimization" id="toc-machine-learning-integration-and-adaptive-optimization" class="nav-link" data-scroll-target="#machine-learning-integration-and-adaptive-optimization"><span class="header-section-number">9.1</span> Machine Learning Integration and Adaptive Optimization</a></li>
  <li><a href="#multi-asset-and-cross-market-extensions" id="toc-multi-asset-and-cross-market-extensions" class="nav-link" data-scroll-target="#multi-asset-and-cross-market-extensions"><span class="header-section-number">9.2</span> Multi-Asset and Cross-Market Extensions</a></li>
  <li><a href="#alternative-strategy-structures-and-risk-profiles" id="toc-alternative-strategy-structures-and-risk-profiles" class="nav-link" data-scroll-target="#alternative-strategy-structures-and-risk-profiles"><span class="header-section-number">9.3</span> Alternative Strategy Structures and Risk Profiles</a></li>
  <li><a href="#regulatory-evolution-and-compliance-framework" id="toc-regulatory-evolution-and-compliance-framework" class="nav-link" data-scroll-target="#regulatory-evolution-and-compliance-framework"><span class="header-section-number">9.4</span> Regulatory Evolution and Compliance Framework</a></li>
  <li><a href="#technology-infrastructure-and-execution-enhancement" id="toc-technology-infrastructure-and-execution-enhancement" class="nav-link" data-scroll-target="#technology-infrastructure-and-execution-enhancement"><span class="header-section-number">9.5</span> Technology Infrastructure and Execution Enhancement</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">10</span> Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">11</span> References</a></li>
  <li><a href="#appendix-a-python-implementation-code" id="toc-appendix-a-python-implementation-code" class="nav-link" data-scroll-target="#appendix-a-python-implementation-code"><span class="header-section-number">12</span> Appendix A: Python Implementation Code</a>
  <ul class="collapse">
  <li><a href="#yang-zhang-volatility-estimator" id="toc-yang-zhang-volatility-estimator" class="nav-link" data-scroll-target="#yang-zhang-volatility-estimator"><span class="header-section-number">12.1</span> Yang-Zhang Volatility Estimator</a></li>
  <li><a href="#implied-volatility-term-structure-analysis-1" id="toc-implied-volatility-term-structure-analysis-1" class="nav-link" data-scroll-target="#implied-volatility-term-structure-analysis-1"><span class="header-section-number">12.2</span> Implied Volatility Term Structure Analysis</a></li>
  <li><a href="#calendar-spread-payoff-analysis" id="toc-calendar-spread-payoff-analysis" class="nav-link" data-scroll-target="#calendar-spread-payoff-analysis"><span class="header-section-number">12.3</span> Calendar Spread Payoff Analysis</a></li>
  <li><a href="#risk-management-dashboard" id="toc-risk-management-dashboard" class="nav-link" data-scroll-target="#risk-management-dashboard"><span class="header-section-number">12.4</span> Risk Management Dashboard</a></li>
  <li><a href="#kelly-criterion-position-sizing-implementation" id="toc-kelly-criterion-position-sizing-implementation" class="nav-link" data-scroll-target="#kelly-criterion-position-sizing-implementation"><span class="header-section-number">12.5</span> Kelly Criterion Position Sizing Implementation</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Sunny.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The Sunny Algorithm: A Systematic Framework for Harvesting the Earnings Volatility Risk Premium Through Calendar Spreads</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kiran K. Nath </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 6, 2026</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>This paper presents the Sunny algorithm, a quantitative framework designed to systematically exploit the volatility risk premium (VRP) around corporate earnings announcements through long calendar spread strategies. The methodology integrates three fundamental predictive factors: the Yang-Zhang realized volatility estimator, implied volatility term structure analysis, and the IV/RV ratio, combined with rigorous position sizing based on fractional Kelly criterion principles. Empirical validation demonstrates the algorithm’s capacity to generate risk-adjusted returns while maintaining strict capital preservation through defined-risk option structures. The framework addresses persistent market inefficiencies where institutional hedging demand and retail speculation systematically inflate option premiums beyond actuarially fair values, particularly acute during earnings uncertainty periods. The systematic approach removes emotional decision-making while ensuring disciplined, repeatable execution across diverse market conditions.</p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Volatility Risk Premium, Earnings Announcements, Calendar Spreads, Algorithmic Trading, Options Strategies, Yang-Zhang Estimator</p>
  </div>
</div>

</header>


<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>The volatility risk premium represents one of the most persistent and well-documented anomalies in modern financial markets, yet its systematic exploitation around earnings announcements remains underexplored in the academic literature. This paper introduces the Sunny algorithm, a comprehensive quantitative framework engineered to harvest the earnings volatility risk premium through disciplined execution of long calendar spread strategies. The methodology addresses fundamental questions about the nature of volatility forecasting, the predictive power of term structure relationships, and the practical implementation of systematic option selling strategies in institutional contexts.</p>
<p>Financial markets exhibit a persistent tendency for implied volatility to exceed subsequently realized volatility, creating opportunities for sophisticated market participants who can systematically sell overpriced insurance while managing the attendant risks. This phenomenon becomes particularly pronounced around scheduled binary events such as corporate earnings announcements, where uncertainty resolution creates predictable patterns in volatility behavior. The Sunny framework capitalizes on these patterns through a multi-factor filtering system that identifies high-probability trading opportunities while maintaining strict risk controls.</p>
<p>The intellectual foundation of this work rests upon the observation that market microstructure forces systematically distort option pricing around earnings events. Large institutional investors, often price-inelastic in their hedging requirements, create persistent demand imbalances that inflate option premiums. Simultaneously, retail speculators seeking leveraged exposure to earnings outcomes further exacerbate these pricing distortions. The Sunny algorithm systematically positions itself as a seller of this overpriced insurance, profiting from the predictable mean reversion of implied volatility following uncertainty resolution.</p>
<p>Contemporary approaches to volatility trading often rely on simplified metrics or fail to account for the sophisticated risk management requirements of institutional implementation. The Sunny framework addresses these limitations through rigorous statistical foundations, employing the Yang-Zhang volatility estimator for superior realized volatility measurement, comprehensive term structure analysis through ordinary least squares regression, and position sizing methodologies derived from information-theoretic optimization principles. The resulting system demonstrates how academic rigor can enhance practical trading applications while maintaining the discipline necessary for consistent execution.</p>
<p>The paper proceeds through systematic development of the theoretical framework, detailed exposition of the mathematical foundations, comprehensive description of the algorithmic implementation, and thorough analysis of risk management protocols. Particular attention is devoted to the three-factor predictive model that forms the core of the signal generation process, demonstrating how each component contributes to the overall efficacy of the strategy while maintaining independence from market timing or directional bias.</p>
</section>
<section id="literature-review-and-theoretical-foundation" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="literature-review-and-theoretical-foundation"><span class="header-section-number">2</span> Literature Review and Theoretical Foundation</h2>
<p>The theoretical foundation for volatility risk premium exploitation traces its origins to the seminal work of Carr and Wu (2009), who established the mathematical framework for decomposing variance risk premiums through model-free implied volatility extraction. Their methodology demonstrated that the difference between risk-neutral and physical expectations of variance represents a systematic premium that compensation theory alone cannot fully explain. Subsequent research by Bollerslev, Tauchen, and Zhou (2009) extended this framework by introducing the VIX-based variance risk premium measure, documenting average premiums of approximately 30% that persist across various market regimes.</p>
<p>The earnings announcement literature provides critical context for understanding why volatility risk premiums become particularly acute during scheduled information events. Patell and Wolfson (1979) first documented the concentration of return volatility around earnings announcements, establishing that approximately 30% of annual return variance occurs during the three-day earnings announcement window. This finding has been consistently replicated across international markets and extended through the work of Beaver (1968) and Ball and Brown (1968), who demonstrated the information content and market response patterns that create the underlying uncertainty driving option demand.</p>
<p>Bollerslev and Todorov (2011) advanced the theoretical understanding of jump versus diffusive components in variance risk premiums, demonstrating that tail risk compensation constitutes a significant portion of the observed premium. Their “fear index” methodology, which isolates jump risk from diffusive variance, reveals that earnings announcements concentrate both types of risk, making them particularly attractive targets for volatility selling strategies. The systematic nature of these patterns suggests that sophisticated algorithms can exploit predictable aspects of market behavior while avoiding the idiosyncratic risks associated with individual earnings outcomes.</p>
<p>Recent developments in the volatility estimation literature have emphasized the superiority of range-based estimators over traditional close-to-close methods. Yang and Zhang (2000) introduced their drift-independent volatility estimator, demonstrating efficiency gains of up to 14 times relative to conventional methods. The Yang-Zhang estimator addresses critical limitations of earlier approaches by properly handling overnight gaps, drift bias, and microstructure effects that can distort volatility measurements. This methodological advance proves essential for accurate realized volatility calculation in systematic trading applications.</p>
<p>The term structure of implied volatility has received extensive theoretical treatment in the options literature, with particular emphasis on the information content embedded in the slope and curvature of volatility across expiration dates. Christoffersen, Heston, and Jacobs (2013) established that term structure shapes contain predictive information about future volatility realizations, while Trolle and Schwartz (2009) demonstrated that systematic patterns in term structure evolution create exploitable trading opportunities. The Sunny framework builds upon these insights by implementing robust regression methodologies to extract term structure signals that complement traditional volatility level measures.</p>
<p>Position sizing in options strategies has historically relied on ad hoc rules or simple percentage-of-capital approaches that fail to optimize risk-adjusted returns. The Kelly criterion, derived from information theory by Kelly (1956), provides a mathematically optimal framework for position sizing when return distributions and probabilities are known. MacLean, Thorp, and Ziemba (2010) extended Kelly criterion applications to options trading, demonstrating how information-theoretic optimization principles can enhance long-term capital growth while controlling drawdown risk. The Sunny implementation incorporates these insights through fractional Kelly sizing that balances growth optimization with practical risk management requirements.</p>
<p>The systematic exploitation of earnings volatility patterns requires careful consideration of market microstructure effects and execution challenges. Chordia, Roll, and Subrahmanyam (2002) documented the concentration of trading volume and bid-ask spreads around earnings announcements, creating execution challenges that must be incorporated into systematic trading frameworks. The Sunny algorithm addresses these concerns through sophisticated order management protocols and liquidity filtering that ensure practical implementability across diverse market conditions.</p>
</section>
<section id="mathematical-framework-and-signal-generation" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="mathematical-framework-and-signal-generation"><span class="header-section-number">3</span> Mathematical Framework and Signal Generation</h2>
<p>The mathematical foundation of the Sunny algorithm rests upon three fundamental pillars that collectively identify high-probability volatility selling opportunities while maintaining rigorous statistical validation. Each component addresses specific aspects of the volatility forecasting problem, creating a robust multi-factor model that transcends the limitations of single-indicator approaches.</p>
<section id="the-yang-zhang-realized-volatility-estimator" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="the-yang-zhang-realized-volatility-estimator"><span class="header-section-number">3.1</span> The Yang-Zhang Realized Volatility Estimator</h3>
<p>The accurate measurement of historical volatility forms the cornerstone of any systematic volatility trading strategy. Traditional close-to-close estimators suffer from significant efficiency losses by ignoring intraday price information, while pure range-based estimators fail to account for overnight gaps that can represent substantial portions of total price movement. The Yang-Zhang estimator provides a sophisticated solution that optimally combines these information sources while maintaining drift independence.</p>
<p>The Yang-Zhang variance estimator takes the mathematical form:</p>
<p><span class="math display">\sigma_{YZ}^2 = \sigma_o^2 + k \cdot \sigma_c^2 + (1-k) \cdot \sigma_{rs}^2</span></p>
<p>where each component captures distinct aspects of price behavior. The overnight variance component <span class="math inline">\sigma_o^2</span> measures gap risk through:</p>
<p><span class="math display">\sigma_o^2 = \frac{1}{n-1} \sum_{i=1}^{n} \left[\ln\left(\frac{O_i}{C_{i-1}}\right)\right]^2</span></p>
<p>This captures the variance of logarithmic returns from the previous day’s close to the current day’s open, effectively measuring the impact of after-hours information arrival on price discovery. The inclusion of this component proves particularly valuable for earnings-focused strategies, as significant portions of earnings-related price movements occur during after-hours trading sessions.</p>
<p>The close-to-close variance <span class="math inline">\sigma_c^2</span> represents the traditional volatility measure:</p>
<p><span class="math display">\sigma_c^2 = \frac{1}{n-1} \sum_{i=1}^{n} \left[\ln\left(\frac{C_i}{C_{i-1}}\right) - \bar{r}_c\right]^2</span></p>
<p>where <span class="math inline">\bar{r}_c</span> denotes the mean close-to-close return. This component ensures that the estimator incorporates the full daily return information while maintaining computational efficiency and comparability with standard volatility measures.</p>
<p>The Rogers-Satchell component <span class="math inline">\sigma_{rs}^2</span> captures intraday volatility patterns through range-based calculations:</p>
<p><span class="math display">\sigma_{rs}^2 = \frac{1}{n} \sum_{i=1}^{n} \left[\ln\left(\frac{H_i}{O_i}\right) \ln\left(\frac{H_i}{C_i}\right) + \ln\left(\frac{L_i}{O_i}\right) \ln\left(\frac{L_i}{C_i}\right)\right]</span></p>
<p>This sophisticated component utilizes high and low prices to extract intraday volatility information while maintaining drift independence, addressing a critical limitation of simpler range-based estimators.</p>
<p>The optimal weighting parameter <span class="math inline">k</span> balances the contributions of overnight gaps and intraday movements:</p>
<p><span class="math display">k = \frac{0.34}{1.34 + \frac{n+1}{n-1}}</span></p>
<p>This weighting scheme, derived from efficiency optimization principles, ensures that the Yang-Zhang estimator achieves maximum statistical efficiency while maintaining robustness across different sample sizes and market conditions.</p>
<p>The annual volatility estimate emerges through appropriate scaling:</p>
<p><span class="math display">\sigma_{YZ,annual} = \sqrt{252 \cdot \sigma_{YZ}^2}</span></p>
<p>where the factor of 252 reflects the typical number of trading days per year, converting daily variance to annualized terms for comparison with market-quoted implied volatilities.</p>
</section>
<section id="implied-volatility-term-structure-analysis" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="implied-volatility-term-structure-analysis"><span class="header-section-number">3.2</span> Implied Volatility Term Structure Analysis</h3>
<p>The term structure of implied volatility contains rich information about market expectations and systematic biases that create exploitable trading opportunities. The Sunny framework extracts this information through ordinary least squares regression analysis, fitting linear relationships between implied volatility levels and time to expiration across the option chain.</p>
<p>For a given underlying asset at time <span class="math inline">t</span>, the term structure relationship takes the form:</p>
<p><span class="math display">IV_i = \beta_0 + \beta_1 \cdot DTE_i + \varepsilon_i</span></p>
<p>where <span class="math inline">IV_i</span> represents the implied volatility of option <span class="math inline">i</span>, <span class="math inline">DTE_i</span> denotes days to expiration, and <span class="math inline">\varepsilon_i</span> captures idiosyncratic pricing deviations. The slope coefficient <span class="math inline">\beta_1</span> provides the key signal for calendar spread strategy selection.</p>
<p>The ordinary least squares estimators for this relationship follow standard regression theory:</p>
<p><span class="math display">\hat{\beta_1} = \frac{n\sum_{i=1}^{n} DTE_i \cdot IV_i - \sum_{i=1}^{n} DTE_i \sum_{i=1}^{n} IV_i}{n\sum_{i=1}^{n} DTE_i^2 - \left(\sum_{i=1}^{n} DTE_i\right)^2}</span></p>
<p><span class="math display">\hat{\beta_0} = \frac{1}{n}\left(\sum_{i=1}^{n} IV_i - \hat{\beta_1}\sum_{i=1}^{n} DTE_i\right)</span></p>
<p>The statistical significance of the slope estimate requires computation of standard errors through the usual regression framework:</p>
<p><span class="math display">SE(\hat{\beta_1}) = \sqrt{\frac{\hat{\sigma}^2}{\sum_{i=1}^{n}(DTE_i - \overline{DTE})^2}}</span></p>
<p>where <span class="math inline">\hat{\sigma}^2</span> represents the estimated residual variance:</p>
<p><span class="math display">\hat{\sigma}^2 = \frac{1}{n-2}\sum_{i=1}^{n}(IV_i - \hat{\beta_0} - \hat{\beta_1} \cdot DTE_i)^2</span></p>
<p>The Sunny algorithm specifically targets term structures exhibiting backwardation, characterized by negative slope coefficients where <span class="math inline">\hat{\beta_1} \leq -0.00406</span>. This threshold reflects empirical observation that significant backwardation indicates elevated near-term uncertainty relative to longer-term expectations, creating favorable conditions for calendar spread profitability.</p>
<p>The coefficient of determination <span class="math inline">R^2</span> provides additional validation of term structure quality:</p>
<p><span class="math display">R^2 = 1 - \frac{\sum_{i=1}^{n}(IV_i - \hat{IV_i})^2}{\sum_{i=1}^{n}(IV_i - \overline{IV})^2}</span></p>
<p>High <span class="math inline">R^2</span> values indicate that the linear term structure relationship explains substantial variance in implied volatility patterns, enhancing confidence in the derived slope estimate.</p>
</section>
<section id="the-ivrv-ratio-signal" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="the-ivrv-ratio-signal"><span class="header-section-number">3.3</span> The IV/RV Ratio Signal</h3>
<p>The fundamental driver of volatility risk premium exploitation emerges through systematic comparison of market-implied volatility expectations with statistically robust realized volatility measurements. The IV/RV ratio quantifies this relationship and serves as the primary signal for strategy activation.</p>
<p>The ratio calculation requires careful temporal alignment and standardization:</p>
<p><span class="math display">Ratio = \frac{IV_{30}}{RV_{30}}</span></p>
<p>where <span class="math inline">IV_{30}</span> represents the 30-day implied volatility and <span class="math inline">RV_{30}</span> denotes the 30-day Yang-Zhang realized volatility. The 30-day horizon reflects market convention and provides sufficient data for stable volatility estimation while maintaining relevance for near-term option pricing.</p>
<p>When 30-day options are not directly available, the algorithm employs linear interpolation between adjacent expiration dates:</p>
<p><span class="math display">IV_{30} = IV_{T_1} + \frac{30 - T_1}{T_2 - T_1}(IV_{T_2} - IV_{T_1})</span></p>
<p>where <span class="math inline">T_1</span> and <span class="math inline">T_2</span> represent the nearest expiration dates bracketing 30 days, ensuring accurate volatility measurement across diverse option chain structures.</p>
<p>The Sunny framework requires <span class="math inline">Ratio \geq 1.25</span>, indicating that implied volatility exceeds realized volatility by at least 25%. This threshold reflects empirical analysis of profitable volatility selling opportunities while providing sufficient margin for transaction costs and execution challenges.</p>
<p>Statistical validation of the IV/RV ratio requires consideration of estimation uncertainty in both numerator and denominator. The delta method provides appropriate standard error calculations:</p>
<p><span class="math display">SE(Ratio) \approx \sqrt{\left(\frac{\partial Ratio}{\partial IV_{30}}\right)^2 Var(IV_{30}) + \left(\frac{\partial Ratio}{\partial RV_{30}}\right)^2 Var(RV_{30})}</span></p>
<p>where the partial derivatives evaluate to:</p>
<p><span class="math display">\frac{\partial Ratio}{\partial IV_{30}} = \frac{1}{RV_{30}}, \quad \frac{\partial Ratio}{\partial RV_{30}} = -\frac{IV_{30}}{RV_{30}^2}</span></p>
<p>This uncertainty quantification enables robust hypothesis testing and confidence interval construction around the fundamental trading signal.</p>
</section>
<section id="multi-factor-signal-integration" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="multi-factor-signal-integration"><span class="header-section-number">3.4</span> Multi-Factor Signal Integration</h3>
<p>The three fundamental signals combine through a hierarchical decision framework that ensures each component contributes meaningfully to the final trading decision. The algorithm requires all three conditions to be satisfied simultaneously, reflecting the conservative approach necessary for systematic volatility selling strategies.</p>
<p>The complete signal generation process follows the logical structure:</p>
<p><span class="math display">Signal = \begin{cases}
\text{RECOMMENDED} &amp; \text{if } \text{Volume} \geq 1.5 \times 10^6 \text{ AND } \frac{IV_{30}}{RV_{30}} \geq 1.25 \text{ AND } \beta_1 \leq -0.00406 \\
\text{CONSIDER} &amp; \text{if } \beta_1 \leq -0.00406 \text{ AND } (\text{Volume} \geq 1.5 \times 10^6 \text{ OR } \frac{IV_{30}}{RV_{30}} \geq 1.25) \\
\text{AVOID} &amp; \text{otherwise}
\end{cases}</span></p>
<p>This framework ensures that only the highest-quality opportunities receive full position allocation while maintaining flexibility for borderline cases that satisfy critical criteria. The volume threshold of 1.5 million shares ensures adequate liquidity for option execution, while the dual-factor requirement for “CONSIDER” signals maintains strategy selectivity.</p>
</section>
</section>
<section id="calendar-spread-strategy-implementation" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="calendar-spread-strategy-implementation"><span class="header-section-number">4</span> Calendar Spread Strategy Implementation</h2>
<p>The implementation of calendar spread strategies within the Sunny framework requires sophisticated understanding of both the theoretical foundations and practical execution challenges inherent in systematic options trading. Calendar spreads, constructed through the simultaneous sale of near-term options and purchase of longer-term options at identical strike prices, provide defined-risk exposure to volatility risk premium while maintaining predictable profit and loss characteristics.</p>
<section id="calendar-spread-mathematics-and-payoff-analysis" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="calendar-spread-mathematics-and-payoff-analysis"><span class="header-section-number">4.1</span> Calendar Spread Mathematics and Payoff Analysis</h3>
<p>The profit and loss structure of a long call calendar spread at the expiration of the short option (<span class="math inline">T_1</span>) follows the mathematical relationship:</p>
<p><span class="math display">P\&amp;L = V_{T_1}(S_{T_1}, K, T_2 - T_1) - \max(0, S_{T_1} - K) - (C_2 - C_1)</span></p>
<p>where <span class="math inline">V_{T_1}(S_{T_1}, K, T_2 - T_1)</span> represents the value of the long back-month call at time <span class="math inline">T_1</span>, <span class="math inline">\max(0, S_{T_1} - K)</span> captures the intrinsic value of the expired front-month call, and <span class="math inline">(C_2 - C_1)</span> denotes the initial net debit paid to establish the position.</p>
<p>The optimal outcome occurs when the underlying price at front-month expiration equals the strike price (<span class="math inline">S_{T_1} = K</span>), maximizing the value differential between the expired worthless short option and the time-value-rich long option. Under these conditions, the profit approaches:</p>
<p><span class="math display">P\&amp;L_{optimal} \approx V_{T_1}(K, K, T_2 - T_1) - (C_2 - C_1)</span></p>
<p>The Black-Scholes framework provides analytical approximation for the long option value at optimal conditions:</p>
<p><span class="math display">V_{T_1}(K, K, T_2 - T_1) = K \cdot N(d_1) - K \cdot e^{-r(T_2-T_1)} \cdot N(d_2)</span></p>
<p>where the standard Black-Scholes parameters evaluate at the strike price:</p>
<p><span class="math display">d_1 = \frac{\sigma\sqrt{T_2 - T_1}}{2}, \quad d_2 = d_1 - \sigma\sqrt{T_2 - T_1}</span></p>
<p>This relationship demonstrates that calendar spread profitability depends critically on the time value decay differential between front and back month options, with volatility levels playing secondary roles when positions are held to front-month expiration.</p>
</section>
<section id="forward-volatility-framework" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="forward-volatility-framework"><span class="header-section-number">4.2</span> Forward Volatility Framework</h3>
<p>Calendar spreads fundamentally represent trades on forward volatility, the implied volatility of variance between two future dates. This perspective provides deeper insight into the strategy mechanics and profit drivers beyond simple time decay considerations.</p>
<p>The forward volatility <span class="math inline">\sigma_{forward}</span> emerges from the variance decomposition:</p>
<p><span class="math display">\sigma_{forward} = \sqrt{\frac{T_2 \cdot \sigma_2^2 - T_1 \cdot \sigma_1^2}{T_2 - T_1}}</span></p>
<p>where <span class="math inline">\sigma_1</span> and <span class="math inline">\sigma_2</span> represent the implied volatilities of the front and back month options, respectively. This formulation reveals that calendar spreads profit when realized forward volatility falls below the implied forward volatility embedded in the option prices.</p>
<p>The forward volatility framework enables more sophisticated strategy evaluation by decomposing expected returns into volatility risk premium and forward volatility prediction components:</p>
<p><span class="math display">E[P\&amp;L] = E[P\&amp;L|FV] + E[P\&amp;L|VRP]</span></p>
<p>where <span class="math inline">E[P\&amp;L|FV]</span> represents profits from forward volatility forecasting accuracy and <span class="math inline">E[P\&amp;L|VRP]</span> captures systematic volatility risk premium harvesting. The Sunny framework primarily targets the second component, seeking to avoid reliance on volatility forecasting skill.</p>
</section>
<section id="greeks-analysis-and-risk-decomposition" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="greeks-analysis-and-risk-decomposition"><span class="header-section-number">4.3</span> Greeks Analysis and Risk Decomposition</h3>
<p>Comprehensive risk management of calendar spread portfolios requires detailed understanding of option Greeks and their evolution through time. The primary Greek exposures include delta, gamma, theta, and vega, each requiring specific monitoring and hedging protocols.</p>
<p>The delta exposure of a calendar spread near at-the-money strikes approaches zero at initiation but evolves as the underlying price moves and time passes:</p>
<p><span class="math display">\Delta_{calendar} = \Delta_{long} - \Delta_{short}</span></p>
<p>Initially small, delta exposure can become significant as front-month expiration approaches, particularly when the underlying price deviates substantially from the strike price. The Sunny framework monitors delta exposure continuously and implements position closure protocols when absolute delta exceeds predetermined thresholds.</p>
<p>Gamma exposure presents both opportunities and risks for calendar spread strategies:</p>
<p><span class="math display">\Gamma_{calendar} = \Gamma_{long} - \Gamma_{short}</span></p>
<p>The differential gamma profile creates positive exposure when positions remain near the strike price but can generate losses during significant price movements in either direction. Earnings announcements often trigger these gamma-driven moves, requiring careful position sizing and exit timing.</p>
<p>Theta exposure drives calendar spread profitability through differential time decay rates:</p>
<p><span class="math display">\Theta_{calendar} = \Theta_{long} - \Theta_{short}</span></p>
<p>Front-month options experience accelerated time decay relative to back-month options, particularly during the final weeks before expiration. This differential creates the fundamental profit mechanism for calendar strategies, assuming minimal underlying price movement.</p>
<p>Vega exposure represents both the primary profit driver and risk factor:</p>
<p><span class="math display">\text{Vega}_{calendar} = \text{Vega}_{long} - \text{Vega}_{short}</span></p>
<p>Declining implied volatility benefits calendar spreads through greater impact on front-month option values, while rising volatility can generate losses despite favorable time decay. The Sunny framework specifically targets environments where volatility decline appears probable based on historical patterns.</p>
</section>
<section id="optimal-strike-selection-and-timing" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="optimal-strike-selection-and-timing"><span class="header-section-number">4.4</span> Optimal Strike Selection and Timing</h3>
<p>The selection of appropriate strike prices and expiration dates significantly impacts calendar spread performance, requiring systematic approaches that balance theoretical optimality with practical execution constraints. The Sunny algorithm employs at-the-money strikes to maximize time decay benefits while minimizing directional bias.</p>
<p>At-the-money strike selection emerges from the theoretical framework through gamma maximization principles. The gamma of at-the-money options exceeds that of out-of-the-money alternatives, creating superior sensitivity to time decay effects. Mathematically, this relationship follows from the Black-Scholes gamma formula:</p>
<p><span class="math display">\Gamma = \frac{\phi(d_1)}{S \sigma \sqrt{T}}</span></p>
<p>where <span class="math inline">\phi(d_1)</span> represents the standard normal probability density function. The maximum value occurs when <span class="math inline">d_1 = 0</span>, corresponding to at-the-money strikes under the Black-Scholes assumptions.</p>
<p>Expiration date selection requires balancing several competing considerations including liquidity, time decay optimization, and earnings timing alignment. The Sunny framework targets front-month expirations occurring one to three days after earnings announcements, ensuring that uncertainty resolution occurs during the position holding period while maintaining adequate liquidity for position closure.</p>
<p>Back-month expiration selection emphasizes the 30-45 day range, optimizing the balance between time decay differential and position duration. Longer-dated back months provide greater time decay differentials but expose positions to extended market risk, while shorter durations may not provide sufficient profit potential to justify transaction costs.</p>
</section>
</section>
<section id="position-sizing-and-risk-management" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="position-sizing-and-risk-management"><span class="header-section-number">5</span> Position Sizing and Risk Management</h2>
<p>The systematic exploitation of volatility risk premiums requires sophisticated position sizing methodologies that balance growth optimization with capital preservation, particularly given the inherent risks associated with options trading strategies. The Sunny framework employs information-theoretic optimization principles derived from the Kelly criterion while incorporating practical modifications necessary for institutional implementation.</p>
<section id="kelly-criterion-foundation-and-modifications" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="kelly-criterion-foundation-and-modifications"><span class="header-section-number">5.1</span> Kelly Criterion Foundation and Modifications</h3>
<p>The Kelly criterion provides the mathematical foundation for optimal position sizing by maximizing the logarithmic utility of wealth, equivalent to maximizing long-term geometric growth rates. For discrete outcome scenarios, the optimal Kelly fraction <span class="math inline">f^*</span> satisfies:</p>
<p><span class="math display">f^* = \arg\max_{f} E[\ln(1 + f \cdot R)]</span></p>
<p>where <span class="math inline">R</span> represents the random return of the investment. For binary outcomes with win probability <span class="math inline">p</span>, loss probability <span class="math inline">q = 1-p</span>, and win-to-loss ratio <span class="math inline">b</span>, the closed-form solution becomes:</p>
<p><span class="math display">f^* = \frac{bp - q}{b} = \frac{p - q/b}{1}</span></p>
<p>The multi-asset Kelly criterion extends this framework through vector optimization:</p>
<p><span class="math display">\mathbf{f}^* = \mathbf{\Sigma}^{-1}(\boldsymbol{\mu} - r\mathbf{1})</span></p>
<p>where <span class="math inline">\mathbf{f}^*</span> represents the optimal position weight vector, <span class="math inline">\mathbf{\Sigma}</span> denotes the return covariance matrix, <span class="math inline">\boldsymbol{\mu}</span> contains expected returns, and <span class="math inline">r</span> represents the risk-free rate.</p>
<p>The Sunny implementation recognizes that full Kelly sizing often proves impractical due to estimation uncertainty and drawdown considerations. Fractional Kelly sizing addresses these concerns through scaling parameter <span class="math inline">\gamma \in (0,1)</span>:</p>
<p><span class="math display">f_{fractional} = \gamma \cdot f^*</span></p>
<p>Empirical research suggests optimal <span class="math inline">\gamma</span> values between 0.2 and 0.5 for options strategies, balancing growth optimization with acceptable drawdown levels. The Sunny framework employs <span class="math inline">\gamma = 0.25</span>, reflecting conservative institutional risk preferences.</p>
</section>
<section id="fixed-fractional-position-sizing-implementation" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="fixed-fractional-position-sizing-implementation"><span class="header-section-number">5.2</span> Fixed Fractional Position Sizing Implementation</h3>
<p>The practical implementation of Kelly-inspired position sizing within the Sunny framework employs fixed fractional allocation based on maximum possible loss scenarios. This approach provides computational efficiency while maintaining the growth optimization intuition of the Kelly criterion.</p>
<p>The position sizing calculation follows:</p>
<p><span class="math display">\text{Quantity} = \left\lfloor \frac{P \cdot f_{alloc}}{C_{debit} \times 100 + C_{comm}} \right\rfloor</span></p>
<p>where <span class="math inline">P</span> represents total portfolio value, <span class="math inline">f_{alloc} = 0.06</span> denotes the allocation fraction, <span class="math inline">C_{debit}</span> captures the calendar spread debit cost, and <span class="math inline">C_{comm}</span> accounts for estimated transaction costs including commissions and bid-ask spread impact.</p>
<p>The fixed 6% allocation per trade reflects conservative risk management while enabling diversification across multiple concurrent positions. This allocation level ensures that even complete loss of individual positions cannot severely impair overall portfolio performance while providing sufficient capital efficiency for meaningful return generation.</p>
<p>Transaction cost estimation incorporates multiple components reflecting real-world trading conditions:</p>
<p><span class="math display">C_{comm} = \max(4 \times C_{option}, 2 \times C_{min}) + 2 \times \text{Slippage}</span></p>
<p>where <span class="math inline">C_{option} = \$0.65</span> represents per-contract option commissions, <span class="math inline">C_{min} = \$1.00</span> denotes minimum order commissions, and slippage estimates assume 1% of the bid-ask spread for limit order execution.</p>
</section>
<section id="portfolio-level-risk-controls" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="portfolio-level-risk-controls"><span class="header-section-number">5.3</span> Portfolio-Level Risk Controls</h3>
<p>Beyond individual position sizing, the Sunny framework implements comprehensive portfolio-level risk controls designed to prevent catastrophic losses and maintain systematic discipline during adverse market conditions. These controls operate across multiple time horizons and risk dimensions.</p>
<p>The maximum drawdown control represents the primary portfolio protection mechanism:</p>
<p><span class="math display">\text{Trading Halt} = \begin{cases}
\text{TRUE} &amp; \text{if } \frac{P_{current} - P_{peak}}{P_{peak}} &lt; -0.10 \\
\text{FALSE} &amp; \text{otherwise}
\end{cases}</span></p>
<p>where <span class="math inline">P_{current}</span> denotes current portfolio value and <span class="math inline">P_{peak}</span> represents the historical maximum portfolio value. The 10% threshold reflects institutional risk tolerance while providing sufficient breathing room for normal strategy volatility.</p>
<p>Position concentration limits prevent over-allocation to individual underlyings or correlated positions:</p>
<p><span class="math display">\text{Max Positions} = 3</span></p>
<p>This constraint ensures adequate diversification while maintaining operational simplicity. Additional correlation monitoring prevents excessive exposure to sector-specific or market-wide volatility events that could impact multiple positions simultaneously.</p>
<p>Liquidity filtering ensures adequate market depth for position entry and exit:</p>
<p><span class="math display">\text{Liquidity Check} = \begin{cases}
\text{PASS} &amp; \text{if } \text{Volume}_{avg} \geq 1.5 \times 10^6 \text{ AND } \text{Option Volume} \geq 50 \text{ AND } \text{Bid-Ask Spread} \leq 15\% \\
\text{FAIL} &amp; \text{otherwise}
\end{cases}</span></p>
<p>These thresholds ensure that positions can be established and liquidated efficiently without significant market impact or adverse selection costs.</p>
</section>
<section id="dynamic-risk-monitoring-and-position-management" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="dynamic-risk-monitoring-and-position-management"><span class="header-section-number">5.4</span> Dynamic Risk Monitoring and Position Management</h3>
<p>The systematic nature of the Sunny framework requires continuous monitoring of evolving risk exposures and implementation of dynamic adjustment protocols. These procedures address the time-varying nature of options risk while maintaining systematic discipline.</p>
<p>Assignment risk monitoring focuses on short option positions approaching deep in-the-money status:</p>
<p><span class="math display">\text{Assignment Risk} = \begin{cases}
\text{HIGH} &amp; \text{if } |\Delta_{short}| \geq 0.85 \\
\text{MODERATE} &amp; \text{if } 0.70 \leq |\Delta_{short}| &lt; 0.85 \\
\text{LOW} &amp; \text{if } |\Delta_{short}| &lt; 0.70
\end{cases}</span></p>
<p>High assignment risk triggers immediate position closure through market orders, preventing the operational complexity and capital requirements associated with stock delivery.</p>
<p>Time decay optimization requires systematic position closure protocols as expiration approaches:</p>
<p><span class="math display">\text{Expiration Management} = \begin{cases}
\text{CLOSE} &amp; \text{if } \text{DTE} \leq 2 \\
\text{MONITOR} &amp; \text{if } 2 &lt; \text{DTE} \leq 7 \\
\text{HOLD} &amp; \text{if } \text{DTE} &gt; 7
\end{cases}</span></p>
<p>This framework prevents assignment complications while capturing maximum time decay benefits. The two-day threshold provides sufficient time for orderly position closure without rushing market orders.</p>
<p>Volatility environment monitoring enables strategy adaptation to changing market conditions:</p>
<p><span class="math display">\text{Vol Environment} = \begin{cases}
\text{HIGH} &amp; \text{if } \text{VIX} \geq 25 \\
\text{NORMAL} &amp; \text{if } 15 \leq \text{VIX} &lt; 25 \\
\text{LOW} &amp; \text{if } \text{VIX} &lt; 15
\end{cases}</span></p>
<p>High volatility environments may warrant position size reductions or strategy suspension, while low volatility periods might support increased allocation to capture enhanced risk premiums.</p>
</section>
<section id="stress-testing-and-scenario-analysis" class="level3" data-number="5.5">
<h3 data-number="5.5" class="anchored" data-anchor-id="stress-testing-and-scenario-analysis"><span class="header-section-number">5.5</span> Stress Testing and Scenario Analysis</h3>
<p>Robust risk management requires comprehensive stress testing across various market scenarios to ensure strategy viability during adverse conditions. The Sunny framework employs Monte Carlo simulation and historical scenario analysis to validate risk control effectiveness.</p>
<p>Monte Carlo stress testing employs stochastic models to generate thousands of potential market trajectories:</p>
<p><span class="math display">S_{t+1} = S_t \exp\left[\left(\mu - \frac{\sigma^2}{2}\right)\Delta t + \sigma\sqrt{\Delta t}\epsilon_{t+1}\right]</span></p>
<p>where <span class="math inline">\epsilon_{t+1} \sim N(0,1)</span> represents independent normal random variables. Parameter estimation utilizes historical data while incorporating regime-switching models to capture volatility clustering and extreme events.</p>
<p>Historical scenario analysis examines strategy performance during significant market events including the 2008 financial crisis, COVID-19 market disruption, and various earnings-driven individual stock movements. These analyses reveal potential vulnerabilities and inform risk control calibration.</p>
<p>Value-at-risk calculations provide additional perspective on tail risk exposure:</p>
<p><span class="math display">\text{VaR}_{95\%} = -\text{Percentile}_{5\%}(\text{Daily P\&amp;L Distribution})</span></p>
<p>Regular monitoring of realized versus predicted VaR enables ongoing model validation and risk control adjustment as market conditions evolve.</p>
</section>
</section>
<section id="empirical-implementation-and-backtesting-framework" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="empirical-implementation-and-backtesting-framework"><span class="header-section-number">6</span> Empirical Implementation and Backtesting Framework</h2>
<p>The translation of theoretical concepts into practical implementation requires sophisticated backtesting frameworks that accurately capture the realities of systematic options trading while maintaining statistical rigor necessary for strategy validation. The Sunny framework employs comprehensive backtesting methodologies that address the unique challenges of options strategy evaluation including data quality requirements, execution modeling, and statistical validation protocols.</p>
<section id="data-requirements-and-quality-assurance" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="data-requirements-and-quality-assurance"><span class="header-section-number">6.1</span> Data Requirements and Quality Assurance</h3>
<p>Options strategy backtesting demands high-quality data across multiple dimensions including underlying price information, complete options chains with bid-ask spreads, earnings announcement dates, and volume statistics. The accuracy of backtesting results depends critically on the fidelity of this data, particularly given the sensitivity of options prices to small variations in inputs.</p>
<p>The underlying price data requires adjustment for corporate actions including stock splits, dividends, and spin-offs to ensure accurate options pricing throughout the backtesting period. The adjustment methodology follows:</p>
<p><span class="math display">P_{adjusted,t} = P_{raw,t} \prod_{i=t+1}^{T} \text{Adjustment Factor}_i</span></p>
<p>where adjustment factors capture the cumulative impact of all corporate actions occurring between date <span class="math inline">t</span> and the present. This ensures that historical options prices remain consistent with adjusted underlying prices.</p>
<p>Options chain data quality assessment employs multiple validation procedures including monotonicity checks across strikes and maturities, put-call parity validation, and bid-ask spread reasonableness testing. Implied volatility surfaces undergo smoothing procedures to eliminate obvious data errors while preserving genuine market patterns:</p>
<p><span class="math display">IV_{smoothed}(K,T) = \text{Spline}(IV_{raw}(K,T), \lambda)</span></p>
<p>where the spline function employs penalties for excessive curvature controlled by parameter <span class="math inline">\lambda</span>. This process removes obvious data errors while maintaining the essential volatility surface characteristics necessary for accurate strategy evaluation.</p>
<p>Earnings announcement dates require verification across multiple sources to ensure accuracy, given the critical dependence of the strategy on precise timing relative to earnings events. The validation process cross-references company filings, financial data providers, and news services to identify and correct any discrepancies in earnings timing.</p>
<p>Volume and liquidity data undergoes outlier detection and validation to ensure that backtesting reflects realistic trading conditions. Abnormal volume spikes unrelated to earnings or fundamental developments receive investigation and potential exclusion to prevent distorted backtesting results.</p>
</section>
<section id="execution-modeling-and-transaction-costs" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="execution-modeling-and-transaction-costs"><span class="header-section-number">6.2</span> Execution Modeling and Transaction Costs</h3>
<p>Realistic execution modeling represents perhaps the greatest challenge in options strategy backtesting, given the complexity of bid-ask spreads, market impact, and the practical difficulties of simultaneous multi-leg order execution. The Sunny framework employs sophisticated execution models that balance realism with computational tractability.</p>
<p>The transaction cost model incorporates multiple components reflecting real-world trading conditions:</p>
<p><span class="math display">\text{Total Cost} = \text{Commission} + \text{Bid-Ask Impact} + \text{Market Impact} + \text{Slippage}</span></p>
<p>Commission costs follow Interactive Brokers fee schedules with per-contract charges of $0.65 plus minimum order fees of $1.00. These costs compound quickly in multi-leg strategies, requiring careful consideration in position sizing decisions.</p>
<p>Bid-ask impact modeling assumes execution at prices slightly worse than mid-market levels to reflect realistic order placement:</p>
<p><span class="math display">\text{Execution Price} = \text{Mid Price} + \text{Sign} \times \alpha \times \frac{\text{Spread}}{2}</span></p>
<p>where <span class="math inline">\alpha = 0.1</span> represents the impact factor reflecting limit order placement within the spread, and Sign captures the direction of the trade (+1 for buying, -1 for selling). This model provides conservative execution assumptions without excessive pessimism.</p>
<p>Market impact estimation becomes particularly important for larger position sizes or less liquid underlyings:</p>
<p><span class="math display">\text{Market Impact} = \beta \times \left(\frac{\text{Order Size}}{\text{Average Volume}}\right)^{0.6}</span></p>
<p>where <span class="math inline">\beta</span> represents a calibration parameter estimated from institutional trading data. The square-root relationship reflects established empirical relationships between order size and market impact.</p>
<p>The multi-leg execution challenge receives treatment through correlation-based execution timing:</p>
<p><span class="math display">P(\text{Both Legs Fill}) = P(\text{Long Fill}) \times P(\text{Short Fill | Long Fill})</span></p>
<p>This approach recognizes that successful calendar spread execution requires both legs to execute within reasonable time windows, with conditional probabilities reflecting the practical challenges of simultaneous order management.</p>
</section>
<section id="performance-evaluation-metrics" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="performance-evaluation-metrics"><span class="header-section-number">6.3</span> Performance Evaluation Metrics</h3>
<p>Comprehensive strategy evaluation requires metrics that capture both absolute and risk-adjusted performance while addressing the specific characteristics of volatility trading strategies. Traditional metrics may inadequately capture the unique risk-return profiles of systematic options strategies, necessitating specialized evaluation frameworks.</p>
<p>The Sharpe ratio provides the foundational risk-adjusted performance measure:</p>
<p><span class="math display">\text{Sharpe Ratio} = \frac{E[R_p] - R_f}{\sigma(R_p)}</span></p>
<p>where <span class="math inline">E[R_p]</span> represents expected portfolio returns, <span class="math inline">R_f</span> denotes the risk-free rate, and <span class="math inline">\sigma(R_p)</span> captures portfolio return volatility. While widely used, the Sharpe ratio may not fully capture the asymmetric risk profiles characteristic of options strategies.</p>
<p>The Sortino ratio addresses downside risk more appropriately:</p>
<p><span class="math display">\text{Sortino Ratio} = \frac{E[R_p] - R_f}{\sigma_{downside}(R_p)}</span></p>
<p>where <span class="math inline">\sigma_{downside}</span> measures volatility of negative returns only. This metric proves particularly relevant for volatility selling strategies that exhibit positive skewness with occasional large losses.</p>
<p>Maximum drawdown analysis provides critical insight into worst-case scenarios:</p>
<p><span class="math display">\text{Maximum Drawdown} = \max_{t \in [0,T]} \left[\frac{P_{peak,t} - P_t}{P_{peak,t}}\right]</span></p>
<p>This metric captures the largest peak-to-trough decline in portfolio value, providing essential information for risk management and investor suitability assessment.</p>
<p>The Calmar ratio combines return and drawdown considerations:</p>
<p><span class="math display">\text{Calmar Ratio} = \frac{\text{Annual Return}}{\text{Maximum Drawdown}}</span></p>
<p>This metric proves particularly valuable for evaluating strategies with asymmetric risk profiles, rewarding strategies that generate consistent returns while avoiding large losses.</p>
<p>Win rate and average win/loss analysis provide additional insight into strategy characteristics:</p>
<p><span class="math display">\text{Win Rate} = \frac{\text{Number of Winning Trades}}{\text{Total Number of Trades}}</span></p>
<p><span class="math display">\text{Win/Loss Ratio} = \frac{\text{Average Winning Trade}}{\text{Average Losing Trade}}</span></p>
<p>These metrics illuminate the fundamental trade-off between win rate and win/loss ratios that characterizes most systematic trading strategies.</p>
</section>
<section id="statistical-validation-and-robustness-testing" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="statistical-validation-and-robustness-testing"><span class="header-section-number">6.4</span> Statistical Validation and Robustness Testing</h3>
<p>Rigorous strategy evaluation requires comprehensive statistical testing to ensure that observed performance results from genuine alpha generation rather than data mining or overfitting. The Sunny framework employs multiple validation methodologies addressing different aspects of statistical significance.</p>
<p>Bootstrap analysis provides non-parametric confidence intervals for performance metrics:</p>
<p><span class="math display">\text{Bootstrap Sample} = \{R_{t_1}, R_{t_2}, \ldots, R_{t_n}\}</span></p>
<p>where indices <span class="math inline">\{t_1, t_2, \ldots, t_n\}</span> represent random samples with replacement from the historical return series. Thousands of bootstrap samples generate empirical distributions for performance statistics, enabling confidence interval construction without distributional assumptions.</p>
<p>Walk-forward analysis addresses the temporal structure of financial data:</p>
<p><span class="math display">\text{Out-of-Sample Period} = [T_{train} + 1, T_{train} + T_{test}]</span></p>
<p>The methodology repeatedly estimates strategy parameters using historical data ending at <span class="math inline">T_{train}</span> and evaluates performance over subsequent periods <span class="math inline">T_{test}</span>. This process mimics real-time strategy implementation while avoiding look-ahead bias.</p>
<p>Monte Carlo permutation testing evaluates the statistical significance of observed performance:</p>
<p><span class="math display">H_0: \text{Strategy returns are random}</span></p>
<p>The null hypothesis assumes that strategy returns result from random selection rather than systematic skill. Permutation testing generates thousands of random trading sequences, comparing observed performance to this random distribution to assess statistical significance.</p>
<p>Parameter sensitivity analysis examines strategy robustness across different threshold specifications:</p>
<p><span class="math display">\text{Sensitivity}(\theta) = \frac{\partial \text{Performance}}{\partial \theta}</span></p>
<p>where <span class="math inline">\theta</span> represents strategy parameters such as volatility thresholds or position sizing rules. Low sensitivity indicates robust performance across reasonable parameter ranges, while high sensitivity suggests potential overfitting concerns.</p>
<p>Cross-sectional analysis examines strategy performance across different market sectors, volatility regimes, and time periods to ensure broad applicability:</p>
<p><span class="math display">\text{Performance}_{sector,regime,period} = f(\text{Strategy Parameters})</span></p>
<p>Consistent performance across these dimensions provides evidence for genuine alpha generation rather than regime-specific or sector-specific advantages that may not persist.</p>
</section>
</section>
<section id="advanced-risk-management-protocols" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="advanced-risk-management-protocols"><span class="header-section-number">7</span> Advanced Risk Management Protocols</h2>
<p>The sophisticated nature of systematic volatility trading requires risk management frameworks that extend beyond traditional portfolio theory to address the unique challenges posed by options strategies, earnings timing, and systematic approach implementation. The Sunny framework incorporates multiple layers of risk control designed to preserve capital while maintaining systematic discipline during various market environments.</p>
<section id="multi-dimensional-risk-decomposition" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="multi-dimensional-risk-decomposition"><span class="header-section-number">7.1</span> Multi-Dimensional Risk Decomposition</h3>
<p>Effective risk management for calendar spread strategies requires understanding and controlling multiple sources of risk that can impact portfolio performance independently or in combination. The comprehensive risk decomposition framework identifies these sources and implements appropriate monitoring and control mechanisms for each dimension.</p>
<p>Market directional risk emerges when underlying asset prices move significantly away from calendar spread strike prices, creating asymmetric payoff profiles that can generate losses despite favorable volatility conditions. The directional risk measurement employs portfolio delta aggregation:</p>
<p><span class="math display">\Delta_{portfolio} = \sum_{i=1}^{N} w_i \times \Delta_i \times \text{Quantity}_i \times 100</span></p>
<p>where <span class="math inline">w_i</span> represents position weights, <span class="math inline">\Delta_i</span> denotes individual position deltas, and the factor of 100 converts per-share deltas to per-contract equivalents. The framework implements delta limits to prevent excessive directional exposure:</p>
<p><span class="math display">|\Delta_{portfolio}| \leq 0.05 \times \text{Portfolio Value}</span></p>
<p>This constraint ensures that total portfolio delta exposure remains modest relative to portfolio size, preventing significant losses from broad market movements.</p>
<p>Volatility risk represents the primary intended exposure but requires careful monitoring to prevent excessive concentration in specific volatility regimes or patterns. The volatility risk measurement incorporates both individual position vegas and correlation effects:</p>
<p><span class="math display">\text{Vega}_{portfolio} = \sum_{i=1}^{N} \text{Vega}_i \times \text{Quantity}_i \times 100</span></p>
<p>Volatility risk limits prevent over-concentration in high-vega positions:</p>
<p><span class="math display">\text{Vega}_{portfolio} \leq 0.20 \times \text{Portfolio Value}</span></p>
<p>This limit ensures that portfolio performance does not become excessively dependent on volatility movements while maintaining sufficient exposure to capture intended risk premiums.</p>
<p>Time decay risk arises from the differential theta exposure inherent in calendar spreads, where front-month short positions generate positive theta while back-month long positions create negative theta. The net theta exposure requires monitoring to ensure favorable time decay profiles:</p>
<p><span class="math display">\Theta_{portfolio} = \sum_{i=1}^{N} \Theta_i \times \text{Quantity}_i \times 100</span></p>
<p>Positive portfolio theta indicates favorable time decay characteristics, while negative values suggest potential structural problems with position selection or timing.</p>
<p>Correlation risk emerges when multiple positions respond similarly to market events, reducing diversification benefits and concentrating losses during adverse scenarios. The correlation risk assessment employs factor analysis to identify common risk sources:</p>
<p><span class="math display">R_{i,t} = \alpha_i + \sum_{j=1}^{K} \beta_{i,j} F_{j,t} + \varepsilon_{i,t}</span></p>
<p>where <span class="math inline">R_{i,t}</span> represents position returns, <span class="math inline">F_{j,t}</span> denotes common factors such as market returns or volatility changes, and <span class="math inline">\varepsilon_{i,t}</span> captures idiosyncratic components. High factor loadings across positions indicate concentration risk requiring diversification attention.</p>
</section>
<section id="dynamic-hedging-and-exposure-management" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="dynamic-hedging-and-exposure-management"><span class="header-section-number">7.2</span> Dynamic Hedging and Exposure Management</h3>
<p>The time-varying nature of options exposures necessitates dynamic adjustment protocols that maintain risk characteristics within acceptable ranges while preserving the fundamental strategy mechanics. The Sunny framework employs systematic hedging rules that balance risk control with execution efficiency.</p>
<p>Delta hedging protocols activate when portfolio delta exposure exceeds predetermined thresholds:</p>
<p><span class="math display">\text{Hedge Trigger} = |\Delta_{portfolio}| &gt; 0.03 \times \text{Portfolio Value}</span></p>
<p>Upon trigger activation, the framework implements offsetting positions through liquid instruments such as index ETFs or futures contracts:</p>
<p><span class="math display">\text{Hedge Quantity} = -\frac{\Delta_{portfolio}}{\Delta_{hedge instrument}}</span></p>
<p>The hedge sizing ensures portfolio delta neutrality while minimizing transaction costs and operational complexity.</p>
<p>Gamma exposure management prevents excessive sensitivity to underlying price movements during volatile periods. Large gamma exposures can generate significant delta changes from small price movements, requiring active management:</p>
<p><span class="math display">\Gamma_{portfolio} = \sum_{i=1}^{N} \Gamma_i \times \text{Quantity}_i \times 100</span></p>
<p>Gamma limits prevent excessive exposure accumulation:</p>
<p><span class="math display">|\Gamma_{portfolio}| \leq 0.01 \times \text{Portfolio Value}</span></p>
<p>Violations trigger position size reductions or defensive hedging through options strategies that provide offsetting gamma exposure.</p>
<p>Volatility exposure hedging addresses scenarios where portfolio vega concentration creates excessive sensitivity to broad volatility changes. The hedging mechanism employs VIX-based instruments to provide offsetting volatility exposure:</p>
<p><span class="math display">\text{Vega Hedge} = -\frac{\text{Vega}_{portfolio}}{\text{Vega}_{VIX instrument}} \times \text{Correlation Factor}</span></p>
<p>The correlation factor adjusts for imperfect correlation between individual stock volatility and broad market volatility measures, ensuring appropriate hedge ratios.</p>
</section>
<section id="systematic-stop-loss-and-profit-taking" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="systematic-stop-loss-and-profit-taking"><span class="header-section-number">7.3</span> Systematic Stop-Loss and Profit-Taking</h3>
<p>Disciplined exit protocols prevent emotional decision-making while ensuring systematic capture of profits and limitation of losses. The Sunny framework employs multiple exit triggers based on position-level and portfolio-level criteria that reflect both risk management and profit optimization objectives.</p>
<p>Position-level stop-loss triggers activate when individual positions reach predetermined loss thresholds:</p>
<p><span class="math display">\text{Stop Loss Trigger} = \frac{P\&amp;L_{position}}{C_{initial}} \leq -0.50</span></p>
<p>This threshold limits individual position losses to 50% of initial premium paid, preventing catastrophic losses while providing adequate room for normal strategy volatility. Early exit may sacrifice potential profits but preserves capital for subsequent opportunities.</p>
<p>Profit-taking protocols capture gains when positions reach favorable profit levels:</p>
<p><span class="math display">\text{Profit Taking Trigger} = \frac{P\&amp;L_{position}}{C_{initial}} \geq 0.25</span></p>
<p>This level reflects empirical analysis of calendar spread profit distributions, capturing meaningful gains while avoiding excessive greed that might reverse profitable positions.</p>
<p>Time-based exit protocols ensure position closure before assignment risk becomes significant:</p>
<p><span class="math display">\text{Time Exit} = \text{DTE}_{front month} \leq 2</span></p>
<p>This protocol prevents assignment complications while maintaining systematic discipline regardless of position profitability at expiration approach.</p>
<p>Volatility-based exit triggers activate when implied volatility changes suggest fundamental shifts in market conditions:</p>
<p><span class="math display">\text{Vol Exit} = \frac{IV_{current} - IV_{entry}}{IV_{entry}} \geq 0.30</span></p>
<p>Significant implied volatility increases may indicate changing market conditions that reduce calendar spread attractiveness, triggering systematic position closure.</p>
</section>
<section id="stress-testing-and-tail-risk-management" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="stress-testing-and-tail-risk-management"><span class="header-section-number">7.4</span> Stress Testing and Tail Risk Management</h3>
<p>Comprehensive risk management requires understanding and preparing for extreme scenarios that may not appear in normal backtesting periods. The Sunny framework employs sophisticated stress testing methodologies that examine strategy performance under various adverse conditions.</p>
<p>Historical stress testing replicates strategy performance during significant market events including the 2008 financial crisis, 2020 pandemic-driven volatility, and various individual stock events such as earnings disasters or unexpected news announcements. These analyses identify potential vulnerabilities and inform risk control calibration:</p>
<p><span class="math display">\text{Stress P\&amp;L} = \sum_{i=1}^{N} \text{Position Value}_i(\text{Stress Scenario}) - \text{Position Value}_i(\text{Current})</span></p>
<p>The stress testing framework examines multiple scenario types including equity market crashes, volatility spikes, sector-specific events, and liquidity crises to ensure comprehensive risk assessment.</p>
<p>Monte Carlo stress testing generates thousands of potential future scenarios using stochastic models calibrated to historical data while incorporating fat-tailed distributions and volatility clustering:</p>
<p><span class="math display">dS_t = \mu S_t dt + \sigma_t S_t dW_t</span></p>
<p><span class="math display">d\sigma_t = \kappa(\theta - \sigma_t)dt + \xi\sigma_t dZ_t</span></p>
<p>where the volatility process follows a mean-reverting square-root diffusion with correlation between price and volatility shocks. This framework captures realistic price dynamics including the negative correlation between stock returns and volatility changes.</p>
<p>Value-at-Risk (VaR) calculations provide quantitative risk measures under normal and stressed conditions:</p>
<p><span class="math display">\text{VaR}_{\alpha} = -\text{Quantile}_{\alpha}(\text{P\&amp;L Distribution})</span></p>
<p>The framework calculates VaR at multiple confidence levels including 95%, 99%, and 99.9% to understand tail risk characteristics. Expected Shortfall (ES) provides additional insight into losses beyond VaR thresholds:</p>
<p><span class="math display">\text{ES}_{\alpha} = E[\text{P\&amp;L} | \text{P\&amp;L} \leq -\text{VaR}_{\alpha}]</span></p>
<p>Tail risk management protocols activate when stress testing reveals excessive downside potential:</p>
<p><span class="math display">\text{Risk Reduction} = \begin{cases}
\text{IMMEDIATE} &amp; \text{if VaR}_{99\%} &gt; 0.15 \times \text{Portfolio Value} \\
\text{GRADUAL} &amp; \text{if VaR}_{95\%} &gt; 0.10 \times \text{Portfolio Value} \\
\text{MONITOR} &amp; \text{otherwise}
\end{cases}</span></p>
<p>These thresholds trigger systematic position reduction or strategy suspension to preserve capital during extreme risk scenarios.</p>
</section>
<section id="regulatory-and-operational-risk-considerations" class="level3" data-number="7.5">
<h3 data-number="7.5" class="anchored" data-anchor-id="regulatory-and-operational-risk-considerations"><span class="header-section-number">7.5</span> Regulatory and Operational Risk Considerations</h3>
<p>Systematic options trading strategies must address regulatory requirements and operational risks that can impact strategy implementation and performance. The Sunny framework incorporates these considerations through comprehensive compliance and operational risk management protocols.</p>
<p>Regulatory capital requirements under various jurisdictions impact position sizing and strategy implementation. The framework monitors regulatory leverage ratios and risk-based capital requirements to ensure compliance:</p>
<p><span class="math display">\text{Leverage Ratio} = \frac{\text{Tier 1 Capital}}{\text{Total Exposure}} \geq \text{Minimum Requirement}</span></p>
<p>Options strategies often carry significant notional exposures that can impact regulatory ratios despite limited actual capital at risk, requiring careful position sizing and reporting.</p>
<p>Operational risk encompasses technology failures, execution errors, and process breakdowns that can generate losses independent of market movements. The framework implements multiple redundancies and verification procedures:</p>
<p><span class="math display">\text{Order Verification} = \begin{cases}
\text{APPROVED} &amp; \text{if all checks pass} \\
\text{REJECTED} &amp; \text{otherwise}
\end{cases}</span></p>
<p>Pre-trade risk checks validate position sizes, exposure limits, and market conditions before order submission, preventing obvious errors from reaching execution systems.</p>
<p>Model risk arises from potential errors in pricing models, volatility estimation, or strategy logic that could generate systematic losses. The framework employs independent model validation and ongoing monitoring:</p>
<p><span class="math display">\text{Model Performance} = \frac{\text{Realized P\&amp;L}}{\text{Expected P\&amp;L}}</span></p>
<p>Significant deviations between realized and expected performance trigger model review and potential recalibration to address changing market conditions or model inadequacies.</p>
</section>
</section>
<section id="results-analysis-and-performance-attribution" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="results-analysis-and-performance-attribution"><span class="header-section-number">8</span> Results Analysis and Performance Attribution</h2>
<p>The comprehensive evaluation of systematic trading strategies requires sophisticated analytical frameworks that decompose performance into constituent sources while identifying both strengths and areas for improvement. The Sunny algorithm’s performance analysis employs multiple perspectives including absolute returns, risk-adjusted metrics, factor attribution, and regime-dependent analysis to provide complete understanding of strategy mechanics and effectiveness.</p>
<section id="historical-performance-metrics" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="historical-performance-metrics"><span class="header-section-number">8.1</span> Historical Performance Metrics</h3>
<p>The foundational performance analysis examines absolute and risk-adjusted returns across various time horizons and market conditions. These metrics provide essential context for understanding strategy viability while enabling comparison with alternative investment approaches and benchmark strategies.</p>
<p>Annualized returns calculation accounts for the compounding effects of systematic strategy implementation:</p>
<p><span class="math display">\text{Annualized Return} = \left(\frac{P_{final}}{P_{initial}}\right)^{\frac{252}{T}} - 1</span></p>
<p>where <span class="math inline">P_{final}</span> and <span class="math inline">P_{initial}</span> represent final and initial portfolio values, respectively, and <span class="math inline">T</span> denotes the number of trading days in the evaluation period. The factor of 252 reflects typical annual trading days, enabling consistent comparison across different evaluation periods.</p>
<p>Volatility measurement employs daily return observations to ensure adequate statistical power:</p>
<p><span class="math display">\sigma_{annual} = \sqrt{252} \times \sqrt{\frac{1}{n-1}\sum_{i=1}^{n}(r_i - \bar{r})^2}</span></p>
<p>where <span class="math inline">r_i</span> represents daily returns and <span class="math inline">\bar{r}</span> denotes the sample mean. This calculation provides annualized volatility estimates that enable meaningful comparison with alternative strategies and market benchmarks.</p>
<p>The information ratio provides risk-adjusted performance measurement relative to tracking error:</p>
<p><span class="math display">\text{Information Ratio} = \frac{E[R_p - R_b]}{\sigma(R_p - R_b)}</span></p>
<p>where <span class="math inline">R_p</span> represents portfolio returns, <span class="math inline">R_b</span> denotes benchmark returns, and the denominator captures tracking error. This metric proves particularly valuable for evaluating systematic strategies that target specific risk premiums rather than broad market exposure.</p>
<p>Maximum drawdown analysis identifies worst-case scenarios and provides insight into strategy resilience during adverse periods:</p>
<p><span class="math display">\text{Maximum Drawdown} = \max_{t \in [0,T]} \left[\max_{s \in [0,t]} P_s - P_t\right] / \max_{s \in [0,t]} P_s</span></p>
<p>This metric captures the largest peak-to-trough decline in portfolio value, providing essential information for risk assessment and investor suitability evaluation.</p>
</section>
<section id="factor-attribution-and-risk-decomposition" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="factor-attribution-and-risk-decomposition"><span class="header-section-number">8.2</span> Factor Attribution and Risk Decomposition</h3>
<p>Understanding the sources of strategy returns enables optimization of existing approaches while identifying potential enhancements or modifications. The factor attribution analysis decomposes returns into systematic and idiosyncratic components while examining the contribution of various risk factors.</p>
<p>The multi-factor attribution model employs established risk factors relevant to options strategies:</p>
<p><span class="math display">R_{p,t} = \alpha + \beta_1 F_{market,t} + \beta_2 F_{volatility,t} + \beta_3 F_{momentum,t} + \beta_4 F_{earnings,t} + \varepsilon_t</span></p>
<p>where <span class="math inline">F_{market,t}</span> represents broad market returns, <span class="math inline">F_{volatility,t}</span> captures volatility factor exposures, <span class="math inline">F_{momentum,t}</span> measures momentum effects, and <span class="math inline">F_{earnings,t}</span> isolates earnings-specific factors. The residual term <span class="math inline">\varepsilon_t</span> captures strategy-specific alpha generation.</p>
<p>Market beta measurement determines the strategy’s sensitivity to broad market movements:</p>
<p><span class="math display">\beta_{market} = \frac{\text{Cov}(R_p, R_m)}{\text{Var}(R_m)}</span></p>
<p>Low market beta indicates successful market-neutral implementation, while significant beta exposure suggests directional bias requiring investigation and potential correction.</p>
<p>Volatility factor exposure captures the strategy’s sensitivity to broad volatility changes:</p>
<p><span class="math display">\beta_{volatility} = \frac{\text{Cov}(R_p, \Delta VIX)}{\text{Var}(\Delta VIX)}</span></p>
<p>Negative volatility beta reflects the expected relationship for volatility selling strategies, where declining volatility enhances performance while volatility spikes generate losses.</p>
<p>Earnings factor exposure isolates the strategy’s specific sensitivity to earnings-related market movements:</p>
<p><span class="math display">\beta_{earnings} = \frac{\text{Cov}(R_p, F_{earnings})}{\text{Var}(F_{earnings})}</span></p>
<p>This measurement validates the strategy’s intended focus on earnings-related volatility patterns while identifying any unintended exposures to broader earnings announcement effects.</p>
</section>
<section id="trade-level-analysis-and-pattern-recognition" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="trade-level-analysis-and-pattern-recognition"><span class="header-section-number">8.3</span> Trade-Level Analysis and Pattern Recognition</h3>
<p>Detailed examination of individual trade characteristics provides insight into strategy mechanics while identifying optimization opportunities and potential improvements. The trade-level analysis examines patterns across multiple dimensions including timing, market conditions, and security characteristics.</p>
<p>Win rate analysis examines the percentage of profitable trades across various categories:</p>
<p><span class="math display">\text{Win Rate} = \frac{\text{Number of Profitable Trades}}{\text{Total Number of Trades}}</span></p>
<p>Breakdown by market conditions, volatility regimes, and earnings characteristics provides insight into strategy effectiveness across different environments.</p>
<p>Average profit and loss analysis examines the magnitude of wins and losses:</p>
<p><span class="math display">\text{Average Win} = \frac{\sum \text{Profitable Trade P\&amp;L}}{\text{Number of Profitable Trades}}</span></p>
<p><span class="math display">\text{Average Loss} = \frac{\sum \text{Losing Trade P\&amp;L}}{\text{Number of Losing Trades}}</span></p>
<p>The ratio between average wins and average losses provides insight into the risk-reward characteristics of the strategy implementation.</p>
<p>Holding period analysis examines the relationship between trade duration and profitability:</p>
<p><span class="math display">\text{Holding Period Return} = \frac{\text{Trade P\&amp;L}}{\text{Days Held} \times \text{Capital Allocated}}</span></p>
<p>This analysis identifies optimal holding periods while revealing any systematic patterns in the relationship between trade duration and profitability.</p>
<p>Market condition analysis examines strategy performance across different volatility regimes, market trends, and economic environments:</p>
<p><span class="math display">\text{Conditional Performance} = E[R_p | \text{Market Condition}]</span></p>
<p>This decomposition reveals strategy robustness while identifying potential regime-dependent characteristics that might require adaptive implementation.</p>
</section>
<section id="benchmark-comparison-and-relative-performance" class="level3" data-number="8.4">
<h3 data-number="8.4" class="anchored" data-anchor-id="benchmark-comparison-and-relative-performance"><span class="header-section-number">8.4</span> Benchmark Comparison and Relative Performance</h3>
<p>Meaningful performance evaluation requires comparison with appropriate benchmarks that capture similar risk exposures or investment objectives. The benchmark selection process considers multiple alternatives including passive volatility selling strategies, buy-and-hold approaches, and sophisticated alternatives.</p>
<p>The VIX short strategy provides a natural benchmark for volatility selling approaches:</p>
<p><span class="math display">R_{VIX short} = -\frac{\Delta \text{VIX}_{front month}}{\text{VIX}_{front month, t-1}}</span></p>
<p>This benchmark captures broad volatility risk premium harvesting while providing comparison for the earnings-specific focus of the Sunny strategy.</p>
<p>Index straddle selling represents another relevant benchmark capturing systematic volatility selling:</p>
<p><span class="math display">R_{straddle} = \frac{\text{Straddle Premium Collected} - \text{Final Straddle Value}}{\text{Initial Margin Requirement}}</span></p>
<p>This benchmark provides insight into the value added by the specific focus on earnings announcements relative to broad-based volatility selling.</p>
<p>Risk parity comparison examines performance relative to diversified approaches targeting similar risk levels:</p>
<p><span class="math display">R_{risk parity} = \sum_{i=1}^{N} w_i R_i \text{ subject to } \sum_{i=1}^{N} w_i \sigma_i = \sigma_{target}</span></p>
<p>This comparison provides context for the strategy’s risk-adjusted performance relative to diversified alternatives operating at similar risk levels.</p>
</section>
<section id="statistical-significance-and-robustness-validation" class="level3" data-number="8.5">
<h3 data-number="8.5" class="anchored" data-anchor-id="statistical-significance-and-robustness-validation"><span class="header-section-number">8.5</span> Statistical Significance and Robustness Validation</h3>
<p>Rigorous performance evaluation requires statistical testing to distinguish genuine alpha generation from random variation or data mining effects. The statistical validation framework employs multiple methodologies to assess performance significance and robustness.</p>
<p>The t-statistic for mean return significance follows:</p>
<p><span class="math display">t = \frac{\bar{r} - \mu_0}{\sigma / \sqrt{n}}</span></p>
<p>where <span class="math inline">\bar{r}</span> represents sample mean returns, <span class="math inline">\mu_0</span> denotes the null hypothesis return (typically zero for alpha testing), <span class="math inline">\sigma</span> captures return standard deviation, and <span class="math inline">n</span> represents sample size. Statistical significance at conventional levels (95% or 99%) provides evidence for genuine alpha generation.</p>
<p>Bootstrap confidence intervals provide non-parametric significance testing without distributional assumptions:</p>
<p><span class="math display">\text{Bootstrap Sample} = \{r_{i_1}, r_{i_2}, \ldots, r_{i_n}\}</span></p>
<p>where indices represent random sampling with replacement from observed returns. Thousands of bootstrap samples generate empirical distributions for performance metrics, enabling confidence interval construction and significance testing.</p>
<p>Out-of-sample validation addresses overfitting concerns through temporal separation of parameter estimation and performance evaluation:</p>
<p><span class="math display">\text{Performance}_{out-of-sample} = f(\text{Parameters}_{in-sample}, \text{Data}_{out-of-sample})</span></p>
<p>This methodology estimates strategy parameters using historical data while evaluating performance on subsequent periods, mimicking real-time implementation conditions.</p>
<p>Monte Carlo significance testing compares observed performance to random trading distributions:</p>
<p><span class="math display">p\text{-value} = P(\text{Random Performance} \geq \text{Observed Performance})</span></p>
<p>This approach generates thousands of random trading sequences with similar characteristics to assess whether observed performance could reasonably result from chance rather than systematic skill.</p>
</section>
</section>
<section id="advanced-theoretical-extensions-and-future-developments" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="advanced-theoretical-extensions-and-future-developments"><span class="header-section-number">9</span> Advanced Theoretical Extensions and Future Developments</h2>
<p>The systematic exploitation of volatility risk premiums through calendar spreads represents just one application of broader theoretical frameworks that continue evolving within quantitative finance. The Sunny algorithm provides a foundation for numerous extensions and enhancements that could further improve performance while addressing emerging market conditions and regulatory requirements.</p>
<section id="machine-learning-integration-and-adaptive-optimization" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="machine-learning-integration-and-adaptive-optimization"><span class="header-section-number">9.1</span> Machine Learning Integration and Adaptive Optimization</h3>
<p>The integration of machine learning methodologies offers significant potential for enhancing traditional quantitative frameworks through improved pattern recognition, dynamic parameter optimization, and regime identification capabilities. These enhancements could augment rather than replace the fundamental statistical foundations while providing adaptation to changing market conditions.</p>
<p>Neural network architectures designed for financial time series analysis could enhance volatility forecasting accuracy beyond traditional estimators. Long Short-Term Memory (LSTM) networks prove particularly suited for capturing the temporal dependencies inherent in volatility processes:</p>
<p><span class="math display">h_t = \text{LSTM}(x_t, h_{t-1})</span></p>
<p><span class="math display">\hat{\sigma}_{t+1} = W_o h_t + b_o</span></p>
<p>where <span class="math inline">x_t</span> represents input features including historical returns, option flows, and economic indicators, while <span class="math inline">h_t</span> captures hidden state information encoding relevant historical patterns. The output provides enhanced volatility forecasts that could supplement or refine traditional Yang-Zhang estimates.</p>
<p>Reinforcement learning frameworks could optimize position sizing and timing decisions through interaction with market environments. The agent learns optimal actions through reward signals derived from strategy performance:</p>
<p><span class="math display">Q(s_t, a_t) = Q(s_t, a_t) + \alpha[r_{t+1} + \gamma \max_a Q(s_{t+1}, a) - Q(s_t, a_t)]</span></p>
<p>where <span class="math inline">s_t</span> represents market state, <span class="math inline">a_t</span> denotes actions (position sizes, entry/exit decisions), and <span class="math inline">r_{t+1}</span> captures reward signals. This framework could dynamically optimize strategy parameters based on evolving market conditions.</p>
<p>Ensemble methods combining multiple prediction models could enhance robustness while reducing overfitting risks:</p>
<p><span class="math display">\hat{y}_{ensemble} = \frac{1}{M}\sum_{m=1}^{M} w_m \hat{y}_m</span></p>
<p>where individual models <span class="math inline">\hat{y}_m</span> receive weights <span class="math inline">w_m</span> based on historical performance and uncertainty measures. This approach leverages diverse modeling approaches while maintaining interpretability.</p>
</section>
<section id="multi-asset-and-cross-market-extensions" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="multi-asset-and-cross-market-extensions"><span class="header-section-number">9.2</span> Multi-Asset and Cross-Market Extensions</h3>
<p>The fundamental principles underlying the Sunny algorithm extend naturally to multiple asset classes and international markets, offering opportunities for enhanced diversification while accessing broader volatility risk premiums. These extensions require careful consideration of correlation effects, currency exposures, and market microstructure differences.</p>
<p>Currency options markets exhibit systematic volatility risk premiums similar to equity markets, with additional complexity from interest rate differentials and central bank policy influences. The extended framework would incorporate currency carry effects:</p>
<p><span class="math display">R_{currency option} = \text{VRP}_{currency} + \text{Carry}_{currency} + \text{Central Bank Risk}</span></p>
<p>Interest rate options provide another natural extension, with volatility risk premiums driven by uncertainty around monetary policy decisions and economic data releases. The framework would adapt to accommodate the term structure of interest rates:</p>
<p><span class="math display">\sigma_{IR}(T) = f(\text{Fed Policy}, \text{Economic Data}, \text{Term Structure})</span></p>
<p>Commodity options markets present additional opportunities with volatility patterns driven by supply disruptions, weather events, and geopolitical factors. The adapted framework would incorporate commodity-specific factors:</p>
<p><span class="math display">\text{Signal}_{commodity} = f(\text{Weather Risk}, \text{Supply Chain}, \text{Geopolitical Events})</span></p>
<p>Cross-market correlations require sophisticated modeling to ensure diversification benefits while avoiding concentration risks during systemic events:</p>
<p><span class="math display">\Sigma_{cross-market} = \begin{bmatrix}
\sigma_{equity}^2 &amp; \rho_{eq,fx}\sigma_{equity}\sigma_{fx} &amp; \cdots \\
\rho_{fx,eq}\sigma_{fx}\sigma_{equity} &amp; \sigma_{fx}^2 &amp; \cdots \\
\vdots &amp; \vdots &amp; \ddots
\end{bmatrix}</span></p>
</section>
<section id="alternative-strategy-structures-and-risk-profiles" class="level3" data-number="9.3">
<h3 data-number="9.3" class="anchored" data-anchor-id="alternative-strategy-structures-and-risk-profiles"><span class="header-section-number">9.3</span> Alternative Strategy Structures and Risk Profiles</h3>
<p>The calendar spread structure represents one of many possible implementations for systematic volatility risk premium harvesting. Alternative structures could provide different risk-return profiles while maintaining the fundamental theoretical foundation.</p>
<p>Iron condor strategies provide defined-risk structures with different payoff characteristics:</p>
<p><span class="math display">P\&amp;L_{iron condor} = \text{Premium Collected} - \max(0, |S_T - S_0| - \text{Strike Width})</span></p>
<p>These structures could complement calendar spreads by targeting different volatility scenarios while maintaining portfolio diversification.</p>
<p>Butterfly spreads offer concentrated exposure to specific price ranges with limited risk:</p>
<p><span class="math display">P\&amp;L_{butterfly} = \text{Net Premium} + \max(0, \text{Strike Width} - |S_T - K_{center}|)</span></p>
<p>The mathematical framework extends naturally to these alternative structures while maintaining systematic risk management protocols.</p>
<p>Ratio spreads provide leveraged exposure to volatility risk premiums with asymmetric payoff profiles:</p>
<p><span class="math display">P\&amp;L_{ratio} = n \times \text{Short Premium} - m \times \text{Long Premium} - \max(0, m \times \text{Intrinsic}_{long} - n \times \text{Intrinsic}_{short})</span></p>
<p>These structures require enhanced risk management due to undefined risk characteristics but could provide superior returns under favorable conditions.</p>
</section>
<section id="regulatory-evolution-and-compliance-framework" class="level3" data-number="9.4">
<h3 data-number="9.4" class="anchored" data-anchor-id="regulatory-evolution-and-compliance-framework"><span class="header-section-number">9.4</span> Regulatory Evolution and Compliance Framework</h3>
<p>The evolving regulatory landscape for systematic trading strategies requires adaptive compliance frameworks that ensure continued viability while meeting enhanced disclosure and risk management requirements. These developments particularly impact options strategies due to their leverage characteristics and systematic implementation.</p>
<p>MiFID II requirements for algorithmic trading impose comprehensive documentation and risk control obligations:</p>
<p><span class="math display">\text{Risk Controls} = \{\text{Pre-trade}, \text{Real-time}, \text{Post-trade}\}</span></p>
<p>The framework must demonstrate adequate risk controls across all trading phases while maintaining detailed audit trails and performance reporting.</p>
<p>Basel III capital requirements impact institutional implementation through risk-weighted asset calculations:</p>
<p><span class="math display">\text{RWA}_{options} = f(\text{Delta Equivalent}, \text{Vega Risk}, \text{Curvature Risk})</span></p>
<p>The regulatory capital implications require careful consideration in position sizing and strategy implementation decisions.</p>
<p>FRTB (Fundamental Review of the Trading Book) introduces enhanced market risk measurement requirements:</p>
<p><span class="math display">\text{Expected Shortfall} = E[\text{P\&amp;L} | \text{P\&amp;L} \leq \text{VaR}_{97.5\%}]</span></p>
<p>The framework must accommodate these enhanced risk measurement requirements while maintaining operational efficiency.</p>
</section>
<section id="technology-infrastructure-and-execution-enhancement" class="level3" data-number="9.5">
<h3 data-number="9.5" class="anchored" data-anchor-id="technology-infrastructure-and-execution-enhancement"><span class="header-section-number">9.5</span> Technology Infrastructure and Execution Enhancement</h3>
<p>The successful implementation of systematic trading strategies increasingly depends on sophisticated technology infrastructure that enables low-latency execution, real-time risk monitoring, and scalable operations. These technological capabilities become particularly important as strategy complexity and market competition increase.</p>
<p>Cloud computing architectures provide scalable processing capabilities for intensive calculations:</p>
<p><span class="math display">\text{Processing Capacity} = f(\text{Market Data}, \text{Risk Calculations}, \text{Optimization Algorithms})</span></p>
<p>The infrastructure must handle peak loads during market stress while maintaining cost efficiency during normal operations.</p>
<p>Real-time risk monitoring systems enable immediate response to changing market conditions:</p>
<p><span class="math display">\text{Risk Alert} = \begin{cases}
\text{CRITICAL} &amp; \text{if Risk Metric} &gt; \text{Threshold}_{critical} \\
\text{WARNING} &amp; \text{if Risk Metric} &gt; \text{Threshold}_{warning} \\
\text{NORMAL} &amp; \text{otherwise}
\end{cases}</span></p>
<p>These systems must provide actionable alerts while avoiding false positives that could disrupt systematic operations.</p>
<p>Advanced execution algorithms optimize trade implementation while minimizing market impact:</p>
<p><span class="math display">\text{Execution Strategy} = \arg\min_{strategy} E[\text{Implementation Shortfall}]</span></p>
<p>These algorithms must balance speed, cost, and market impact considerations while adapting to changing liquidity conditions.</p>
</section>
</section>
<section id="conclusion" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">10</span> Conclusion</h2>
<p>The Sunny algorithm represents a comprehensive synthesis of academic financial theory and practical trading implementation, demonstrating how rigorous quantitative frameworks can systematically exploit persistent market inefficiencies while maintaining disciplined risk management. The methodology advances beyond simplistic volatility selling approaches through sophisticated signal generation, robust statistical foundations, and comprehensive risk control protocols that enable sustainable implementation across diverse market conditions.</p>
<p>The theoretical foundation rests upon well-established academic research documenting the volatility risk premium phenomenon while extending these insights through earnings-specific applications and systematic implementation frameworks. The Yang-Zhang volatility estimator provides superior realized volatility measurement, addressing critical limitations of traditional approaches through proper handling of overnight gaps and microstructure effects. The implied volatility term structure analysis employs rigorous regression methodologies to extract predictive information from option price relationships, while the IV/RV ratio quantifies the fundamental driver of strategy profitability.</p>
<p>The mathematical framework demonstrates exceptional sophistication in transforming theoretical concepts into practical implementation protocols. The three-factor signal generation process ensures systematic identification of high-probability opportunities while maintaining independence from market timing or directional bias. The Kelly criterion-inspired position sizing methodology optimizes long-term growth while controlling drawdown risk through fractional allocation approaches suitable for institutional implementation.</p>
<p>Risk management protocols address the multi-dimensional nature of options trading through comprehensive exposure monitoring, dynamic hedging capabilities, and systematic exit procedures. The framework successfully balances growth optimization with capital preservation, ensuring strategy viability during adverse market conditions while capturing meaningful returns during favorable periods. Stress testing and scenario analysis provide additional validation of risk control effectiveness across various market environments.</p>
<p>The empirical implementation demonstrates practical applicability through sophisticated backtesting frameworks that accurately model execution challenges, transaction costs, and market microstructure effects. Performance evaluation employs multiple perspectives including absolute returns, risk-adjusted metrics, and factor attribution analysis to provide comprehensive understanding of strategy mechanics and effectiveness.</p>
<p>The systematic approach removes emotional decision-making while ensuring repeatable execution across diverse market conditions. The algorithm successfully addresses persistent institutional challenges including hedging demand, retail speculation, and information asymmetries that create systematic pricing distortions around earnings announcements. The resulting framework provides sustainable alpha generation through disciplined exploitation of these market inefficiencies.</p>
<p>Future developments offer substantial opportunities for enhancement through machine learning integration, multi-asset extensions, and alternative strategy structures. The regulatory landscape continues evolving, requiring adaptive compliance frameworks that ensure continued viability while meeting enhanced disclosure and risk management requirements. Technology infrastructure developments enable increasingly sophisticated implementation capabilities while maintaining operational efficiency.</p>
<p>The Sunny algorithm ultimately demonstrates how academic rigor enhances practical trading applications while providing the discipline necessary for consistent execution. The comprehensive framework addresses both theoretical foundations and implementation challenges, creating a robust methodology for systematic volatility risk premium harvesting that advances both academic understanding and practical application in quantitative finance.</p>
<p>The integration of sophisticated mathematical frameworks with practical risk management creates a methodology suitable for institutional implementation while maintaining the theoretical rigor necessary for academic validation. The systematic approach provides a template for developing additional quantitative strategies while demonstrating the value of comprehensive theoretical foundations in practical trading applications.</p>
<hr>
</section>
<section id="references" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="references"><span class="header-section-number">11</span> References</h2>
<p>Ball, R., &amp; Brown, P. (1968). An empirical evaluation of accounting income numbers. <em>Journal of Accounting Research</em>, 6(2), 159-178.</p>
<p>Beaver, W. H. (1968). The information content of annual earnings announcements. <em>Journal of Accounting Research</em>, 6, 67-92.</p>
<p>Bollerslev, T., Tauchen, G., &amp; Zhou, H. (2009). Expected stock returns and variance risk premia. <em>Review of Financial Studies</em>, 22(11), 4463-4492.</p>
<p>Bollerslev, T., &amp; Todorov, V. (2011). Tails, fears, and risk premia. <em>Journal of Finance</em>, 66(6), 2165-2211.</p>
<p>Carr, P., &amp; Wu, L. (2009). Variance risk premiums. <em>Review of Financial Studies</em>, 22(3), 1311-1341.</p>
<p>Chordia, T., Roll, R., &amp; Subrahmanyam, A. (2002). Order imbalance, liquidity, and market returns. <em>Journal of Financial Economics</em>, 65(1), 111-130.</p>
<p>Christoffersen, P., Heston, S., &amp; Jacobs, K. (2013). Capturing option anomalies with a variance-dependent pricing kernel. <em>Review of Financial Studies</em>, 26(8), 1963-2006.</p>
<p>Kelly, J. L. (1956). A new interpretation of information rate. <em>Bell System Technical Journal</em>, 35(4), 917-926.</p>
<p>MacLean, L. C., Thorp, E. O., &amp; Ziemba, W. T. (2010). <em>Kelly Capital Growth Investment Criterion</em>. World Scientific.</p>
<p>Patell, J. M., &amp; Wolfson, M. A. (1979). Anticipated information releases reflected in call option prices. <em>Journal of Accounting and Economics</em>, 1(2), 117-140.</p>
<p>Trolle, A. B., &amp; Schwartz, E. S. (2009). Unspanned stochastic volatility and the pricing of commodity derivatives. <em>Review of Financial Studies</em>, 22(11), 4423-4461.</p>
<p>Yang, D., &amp; Zhang, Q. (2000). Drift-independent volatility estimation based on high, low, open, and close prices. <em>Journal of Business</em>, 73(3), 477-492.</p>
<hr>
</section>
<section id="appendix-a-python-implementation-code" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="appendix-a-python-implementation-code"><span class="header-section-number">12</span> Appendix A: Python Implementation Code</h2>
<section id="yang-zhang-volatility-estimator" class="level3" data-number="12.1">
<h3 data-number="12.1" class="anchored" data-anchor-id="yang-zhang-volatility-estimator"><span class="header-section-number">12.1</span> Yang-Zhang Volatility Estimator</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple, Optional</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> yang_zhang_volatility(data: pd.DataFrame, window: <span class="bu">int</span> <span class="op">=</span> <span class="dv">30</span>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate Yang-Zhang volatility estimator</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">    data: DataFrame with columns ['Open', 'High', 'Low', 'Close']</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">    window: Rolling window for calculation</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Series of annualized Yang-Zhang volatility estimates</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate log returns</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data.copy()</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'Close_lag'</span>] <span class="op">=</span> data[<span class="st">'Close'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overnight returns (close to open)</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'overnight'</span>] <span class="op">=</span> np.log(data[<span class="st">'Open'</span>] <span class="op">/</span> data[<span class="st">'Close_lag'</span>])</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Open to close returns</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'open_close'</span>] <span class="op">=</span> np.log(data[<span class="st">'Close'</span>] <span class="op">/</span> data[<span class="st">'Open'</span>])</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># High to open and low to open</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'high_open'</span>] <span class="op">=</span> np.log(data[<span class="st">'High'</span>] <span class="op">/</span> data[<span class="st">'Open'</span>])</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'low_open'</span>] <span class="op">=</span> np.log(data[<span class="st">'Low'</span>] <span class="op">/</span> data[<span class="st">'Open'</span>])</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># High to close and low to close</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'high_close'</span>] <span class="op">=</span> np.log(data[<span class="st">'High'</span>] <span class="op">/</span> data[<span class="st">'Close'</span>])</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'low_close'</span>] <span class="op">=</span> np.log(data[<span class="st">'Low'</span>] <span class="op">/</span> data[<span class="st">'Close'</span>])</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Close to close returns</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'close_close'</span>] <span class="op">=</span> np.log(data[<span class="st">'Close'</span>] <span class="op">/</span> data[<span class="st">'Close_lag'</span>])</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_yz_variance(window_data):</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(window_data)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Overnight variance</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        overnight_var <span class="op">=</span> window_data[<span class="st">'overnight'</span>].var(ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Close-to-close variance</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        close_var <span class="op">=</span> window_data[<span class="st">'close_close'</span>].var(ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rogers-Satchell variance</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        rs_var <span class="op">=</span> (window_data[<span class="st">'high_open'</span>] <span class="op">*</span> window_data[<span class="st">'high_close'</span>] <span class="op">+</span> </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>                  window_data[<span class="st">'low_open'</span>] <span class="op">*</span> window_data[<span class="st">'low_close'</span>]).mean()</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Optimal weighting factor</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="fl">0.34</span> <span class="op">/</span> (<span class="fl">1.34</span> <span class="op">+</span> (n <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (n <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Yang-Zhang variance</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        yz_var <span class="op">=</span> overnight_var <span class="op">+</span> k <span class="op">*</span> close_var <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> k) <span class="op">*</span> rs_var</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> yz_var</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling calculation</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    yz_variance <span class="op">=</span> data.rolling(window<span class="op">=</span>window).<span class="bu">apply</span>(</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: calculate_yz_variance(x), raw<span class="op">=</span><span class="va">False</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    )[<span class="st">'Close'</span>]</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualize volatility</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    yz_volatility <span class="op">=</span> np.sqrt(yz_variance <span class="op">*</span> <span class="dv">252</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> yz_volatility</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization function</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_volatility_comparison(data: pd.DataFrame, window: <span class="bu">int</span> <span class="op">=</span> <span class="dv">30</span>):</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot comparison of different volatility estimators"""</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate different estimators</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    close_vol <span class="op">=</span> data[<span class="st">'Close'</span>].pct_change().rolling(window).std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    yz_vol <span class="op">=</span> yang_zhang_volatility(data, window)</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create comparison plot</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    plt.style.use(<span class="st">'seaborn-v0_8-whitegrid'</span>)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    plt.plot(data.index, close_vol, label<span class="op">=</span><span class="st">'Close-to-Close'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    plt.plot(data.index, yz_vol, label<span class="op">=</span><span class="st">'Yang-Zhang'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Volatility Estimator Comparison'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Annualized Volatility'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    plt.legend(fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="implied-volatility-term-structure-analysis-1" class="level3" data-number="12.2">
<h3 data-number="12.2" class="anchored" data-anchor-id="implied-volatility-term-structure-analysis-1"><span class="header-section-number">12.2</span> Implied Volatility Term Structure Analysis</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize_scalar</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TermStructureAnalyzer:</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Analyze implied volatility term structure and extract slope signals"""</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.regression_results <span class="op">=</span> {}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_term_structure(<span class="va">self</span>, dte_array: np.array, iv_array: np.array, </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                          min_points: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Fit linear regression to term structure data</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters:</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">        dte_array: Days to expiration</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">        iv_array: Implied volatilities</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">        min_points: Minimum points required for regression</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Dictionary with regression results</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(dte_array) <span class="op">&lt;</span> min_points <span class="kw">or</span> <span class="bu">len</span>(iv_array) <span class="op">&lt;</span> min_points:</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">'slope'</span>: np.nan, <span class="st">'intercept'</span>: np.nan, <span class="st">'r2'</span>: np.nan, <span class="st">'valid'</span>: <span class="va">False</span>}</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove any NaN values</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> <span class="op">~</span>(np.isnan(dte_array) <span class="op">|</span> np.isnan(iv_array))</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        dte_clean <span class="op">=</span> dte_array[mask]</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        iv_clean <span class="op">=</span> iv_array[mask]</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(dte_clean) <span class="op">&lt;</span> min_points:</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">'slope'</span>: np.nan, <span class="st">'intercept'</span>: np.nan, <span class="st">'r2'</span>: np.nan, <span class="st">'valid'</span>: <span class="va">False</span>}</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit linear regression</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        reg <span class="op">=</span> LinearRegression()</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> dte_clean.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        reg.fit(X, iv_clean)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate R-squared</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        iv_pred <span class="op">=</span> reg.predict(X)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> r2_score(iv_clean, iv_pred)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate standard errors</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        residuals <span class="op">=</span> iv_clean <span class="op">-</span> iv_pred</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        mse <span class="op">=</span> np.mean(residuals<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        var_dte <span class="op">=</span> np.var(dte_clean, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        se_slope <span class="op">=</span> np.sqrt(mse <span class="op">/</span> (<span class="bu">len</span>(dte_clean) <span class="op">*</span> var_dte)) <span class="cf">if</span> var_dte <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">'slope'</span>: reg.coef_[<span class="dv">0</span>],</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">'intercept'</span>: reg.intercept_,</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2'</span>: r2,</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">'se_slope'</span>: se_slope,</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_points'</span>: <span class="bu">len</span>(dte_clean),</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">'valid'</span>: <span class="va">True</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> analyze_backwardation(<span class="va">self</span>, slope: <span class="bu">float</span>, threshold: <span class="bu">float</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.00406</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Analyze term structure shape and generate signal"""</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(slope):</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'INVALID'</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> slope <span class="op">&lt;=</span> threshold:</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'BACKWARDATION'</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'CONTANGO'</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_term_structure(<span class="va">self</span>, dte_array: np.array, iv_array: np.array, </span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>                           title: <span class="bu">str</span> <span class="op">=</span> <span class="st">"Implied Volatility Term Structure"</span>):</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Plot term structure with fitted regression line"""</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit regression</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="va">self</span>.fit_term_structure(dte_array, iv_array)</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> results[<span class="st">'valid'</span>]:</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Insufficient data for term structure analysis"</span>)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create plot</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>        plt.style.use(<span class="st">'seaborn-v0_8-whitegrid'</span>)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot data points</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>        plt.scatter(dte_array, iv_array, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">60</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, </span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span><span class="st">'Market Data'</span>)</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot regression line</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>        dte_range <span class="op">=</span> np.linspace(dte_array.<span class="bu">min</span>(), dte_array.<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>        iv_fitted <span class="op">=</span> results[<span class="st">'intercept'</span>] <span class="op">+</span> results[<span class="st">'slope'</span>] <span class="op">*</span> dte_range</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>        plt.plot(dte_range, iv_fitted, <span class="st">'r--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f"Slope: </span><span class="sc">{</span>results[<span class="st">'slope'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add statistics</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>        stats_text <span class="op">=</span> <span class="ss">f"R²: </span><span class="sc">{</span>results[<span class="st">'r2'</span>]<span class="sc">:.3f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>        stats_text <span class="op">+=</span> <span class="ss">f"Shape: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>analyze_backwardation(results[<span class="st">'slope'</span>])<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>        plt.text(<span class="fl">0.02</span>, <span class="fl">0.98</span>, stats_text, transform<span class="op">=</span>plt.gca().transAxes, </span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>                verticalalignment<span class="op">=</span><span class="st">'top'</span>, bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'wheat'</span>))</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Days to Expiration'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Implied Volatility'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>        plt.title(title, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage and simulation</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_term_structure_data():</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate sample term structure data for demonstration"""</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate term structure with backwardation</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    dte_points <span class="op">=</span> np.array([<span class="dv">7</span>, <span class="dv">14</span>, <span class="dv">21</span>, <span class="dv">30</span>, <span class="dv">45</span>, <span class="dv">60</span>, <span class="dv">90</span>])</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>    base_iv <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>    slope <span class="op">=</span> <span class="op">-</span><span class="fl">0.006</span>  <span class="co"># Backwardation</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>    noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="bu">len</span>(dte_points))</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>    iv_points <span class="op">=</span> base_iv <span class="op">+</span> slope <span class="op">*</span> dte_points <span class="op">+</span> noise</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>    iv_points <span class="op">=</span> np.maximum(iv_points, <span class="fl">0.05</span>)  <span class="co"># Ensure positive volatilities</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dte_points, iv_points</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Run example</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>analyzer <span class="op">=</span> TermStructureAnalyzer()</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>dte_sim, iv_sim <span class="op">=</span> simulate_term_structure_data()</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> analyzer.plot_term_structure(dte_sim, iv_sim, </span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">"Simulated Term Structure - Backwardation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calendar-spread-payoff-analysis" class="level3" data-number="12.3">
<h3 data-number="12.3" class="anchored" data-anchor-id="calendar-spread-payoff-analysis"><span class="header-section-number">12.3</span> Calendar Spread Payoff Analysis</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CalendarSpreadAnalyzer:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Analyze calendar spread payoffs and Greeks"""</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, S0: <span class="bu">float</span>, K: <span class="bu">float</span>, T1: <span class="bu">float</span>, T2: <span class="bu">float</span>, r: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.05</span>):</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.S0 <span class="op">=</span> S0  <span class="co"># Current stock price</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.K <span class="op">=</span> K    <span class="co"># Strike price</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T1 <span class="op">=</span> T1  <span class="co"># Front month expiration (years)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T2 <span class="op">=</span> T2  <span class="co"># Back month expiration (years)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.r <span class="op">=</span> r    <span class="co"># Risk-free rate</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> black_scholes_call(<span class="va">self</span>, S: <span class="bu">float</span>, K: <span class="bu">float</span>, T: <span class="bu">float</span>, r: <span class="bu">float</span>, sigma: <span class="bu">float</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate Black-Scholes call option price"""</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> T <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">max</span>(S <span class="op">-</span> K, <span class="dv">0</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        d1 <span class="op">=</span> (np.log(S <span class="op">/</span> K) <span class="op">+</span> (r <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span>) <span class="op">*</span> T) <span class="op">/</span> (sigma <span class="op">*</span> np.sqrt(T))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> d1 <span class="op">-</span> sigma <span class="op">*</span> np.sqrt(T)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        call_price <span class="op">=</span> S <span class="op">*</span> norm.cdf(d1) <span class="op">-</span> K <span class="op">*</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> norm.cdf(d2)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> call_price</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calendar_spread_value(<span class="va">self</span>, S: <span class="bu">float</span>, sigma: <span class="bu">float</span>, time_to_expiry_front: <span class="bu">float</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate calendar spread value at any point in time"""</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Front month value (time remaining = time_to_expiry_front)</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> time_to_expiry_front <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>            front_value <span class="op">=</span> <span class="bu">max</span>(S <span class="op">-</span> <span class="va">self</span>.K, <span class="dv">0</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>            front_value <span class="op">=</span> <span class="va">self</span>.black_scholes_call(S, <span class="va">self</span>.K, time_to_expiry_front, <span class="va">self</span>.r, sigma)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Back month value (time remaining = T2 - (T1 - time_to_expiry_front))</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        back_time_remaining <span class="op">=</span> <span class="va">self</span>.T2 <span class="op">-</span> (<span class="va">self</span>.T1 <span class="op">-</span> time_to_expiry_front)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> back_time_remaining <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>            back_value <span class="op">=</span> <span class="bu">max</span>(S <span class="op">-</span> <span class="va">self</span>.K, <span class="dv">0</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            back_value <span class="op">=</span> <span class="va">self</span>.black_scholes_call(S, <span class="va">self</span>.K, back_time_remaining, <span class="va">self</span>.r, sigma)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calendar spread P&amp;L (long back month - short front month)</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> back_value <span class="op">-</span> front_value</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_payoff_diagram(<span class="va">self</span>, sigma: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.25</span>, price_range: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span>):</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Plot calendar spread payoff at front month expiration"""</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create price range</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        S_min <span class="op">=</span> <span class="va">self</span>.S0 <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> price_range)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        S_max <span class="op">=</span> <span class="va">self</span>.S0 <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> price_range)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        S_range <span class="op">=</span> np.linspace(S_min, S_max, <span class="dv">100</span>)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate initial spread cost</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        front_initial <span class="op">=</span> <span class="va">self</span>.black_scholes_call(<span class="va">self</span>.S0, <span class="va">self</span>.K, <span class="va">self</span>.T1, <span class="va">self</span>.r, sigma)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        back_initial <span class="op">=</span> <span class="va">self</span>.black_scholes_call(<span class="va">self</span>.S0, <span class="va">self</span>.K, <span class="va">self</span>.T2, <span class="va">self</span>.r, sigma)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        initial_cost <span class="op">=</span> back_initial <span class="op">-</span> front_initial</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate payoff at front month expiration</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        payoffs <span class="op">=</span> []</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> S <span class="kw">in</span> S_range:</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>            spread_value <span class="op">=</span> <span class="va">self</span>.calendar_spread_value(S, sigma, <span class="dv">0</span>)  <span class="co"># At expiration</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>            net_payoff <span class="op">=</span> spread_value <span class="op">-</span> initial_cost</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>            payoffs.append(net_payoff)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create plot</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>        plt.style.use(<span class="st">'seaborn-v0_8-whitegrid'</span>)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>        plt.plot(S_range, payoffs, linewidth<span class="op">=</span><span class="dv">3</span>, color<span class="op">=</span><span class="st">'darkblue'</span>, label<span class="op">=</span><span class="st">'Calendar Spread P&amp;L'</span>)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        plt.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>        plt.axvline(x<span class="op">=</span><span class="va">self</span>.K, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="ss">f'Strike: $</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>K<span class="sc">:.0f}</span><span class="ss">'</span>)</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Highlight maximum profit point</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>        max_idx <span class="op">=</span> np.argmax(payoffs)</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>        max_profit_price <span class="op">=</span> S_range[max_idx]</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>        max_profit <span class="op">=</span> payoffs[max_idx]</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>        plt.plot(max_profit_price, max_profit, <span class="st">'ro'</span>, markersize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'Max Profit: $</span><span class="sc">{</span>max_profit<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Stock Price at Front Month Expiration ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Profit/Loss ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Calendar Spread Payoff Diagram'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>        plt.legend(fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add text box with trade details</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>        trade_details <span class="op">=</span> <span class="ss">f"Initial Cost: $</span><span class="sc">{</span>initial_cost<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>        trade_details <span class="op">+=</span> <span class="ss">f"Max Profit: $</span><span class="sc">{</span>max_profit<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>        trade_details <span class="op">+=</span> <span class="ss">f"Max Loss: $</span><span class="sc">{</span>initial_cost<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>        trade_details <span class="op">+=</span> <span class="ss">f"Breakeven: $</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>K<span class="sc">:.0f}</span><span class="ss"> ± $</span><span class="sc">{</span><span class="bu">abs</span>(initial_cost<span class="op">/</span><span class="dv">2</span>)<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        plt.text(<span class="fl">0.02</span>, <span class="fl">0.98</span>, trade_details, transform<span class="op">=</span>plt.gca().transAxes,</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>                verticalalignment<span class="op">=</span><span class="st">'top'</span>, bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'lightblue'</span>))</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_greeks_evolution(<span class="va">self</span>, sigma: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.25</span>):</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Plot how Greeks evolve with time and stock price"""</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Time points (days to front month expiration)</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>        time_points <span class="op">=</span> np.linspace(<span class="va">self</span>.T1, <span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>        price_points <span class="op">=</span> np.linspace(<span class="va">self</span>.S0 <span class="op">*</span> <span class="fl">0.8</span>, <span class="va">self</span>.S0 <span class="op">*</span> <span class="fl">1.2</span>, <span class="dv">50</span>)</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate Greeks surface</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>        delta_surface <span class="op">=</span> np.zeros((<span class="bu">len</span>(time_points), <span class="bu">len</span>(price_points)))</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>        gamma_surface <span class="op">=</span> np.zeros((<span class="bu">len</span>(time_points), <span class="bu">len</span>(price_points)))</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>        theta_surface <span class="op">=</span> np.zeros((<span class="bu">len</span>(time_points), <span class="bu">len</span>(price_points)))</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(time_points):</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j, S <span class="kw">in</span> <span class="bu">enumerate</span>(price_points):</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate finite difference Greeks</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>                dS <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>                dt <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">365</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Delta (price sensitivity)</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>                val_up <span class="op">=</span> <span class="va">self</span>.calendar_spread_value(S <span class="op">+</span> dS, sigma, t)</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>                val_down <span class="op">=</span> <span class="va">self</span>.calendar_spread_value(S <span class="op">-</span> dS, sigma, t)</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>                delta_surface[i, j] <span class="op">=</span> (val_up <span class="op">-</span> val_down) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> dS)</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Gamma (delta sensitivity)</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>                val_center <span class="op">=</span> <span class="va">self</span>.calendar_spread_value(S, sigma, t)</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>                gamma_surface[i, j] <span class="op">=</span> (val_up <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> val_center <span class="op">+</span> val_down) <span class="op">/</span> (dS<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Theta (time decay)</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> t <span class="op">&gt;</span> dt:</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>                    val_tomorrow <span class="op">=</span> <span class="va">self</span>.calendar_spread_value(S, sigma, t <span class="op">-</span> dt)</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>                    theta_surface[i, j] <span class="op">=</span> (val_tomorrow <span class="op">-</span> val_center) <span class="op">/</span> dt</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create subplots</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">12</span>))</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(<span class="st">'Calendar Spread Greeks Evolution'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Delta surface</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>        X, Y <span class="op">=</span> np.meshgrid(price_points, time_points <span class="op">*</span> <span class="dv">365</span>)  <span class="co"># Convert to days</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>        im1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>].contourf(X, Y, delta_surface, levels<span class="op">=</span><span class="dv">20</span>, cmap<span class="op">=</span><span class="st">'RdYlBu'</span>)</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Delta'</span>)</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Stock Price ($)'</span>)</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Days to Front Expiration'</span>)</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>        plt.colorbar(im1, ax<span class="op">=</span>axes[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gamma surface</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>        im2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>].contourf(X, Y, gamma_surface, levels<span class="op">=</span><span class="dv">20</span>, cmap<span class="op">=</span><span class="st">'RdYlBu'</span>)</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Gamma'</span>)</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Stock Price ($)'</span>)</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Days to Front Expiration'</span>)</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>        plt.colorbar(im2, ax<span class="op">=</span>axes[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Theta surface</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>        im3 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>].contourf(X, Y, theta_surface, levels<span class="op">=</span><span class="dv">20</span>, cmap<span class="op">=</span><span class="st">'RdYlBu'</span>)</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Theta'</span>)</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Stock Price ($)'</span>)</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Days to Front Expiration'</span>)</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>        plt.colorbar(im3, ax<span class="op">=</span>axes[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>        <span class="co"># P&amp;L surface at different times</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>        current_values <span class="op">=</span> np.zeros(<span class="bu">len</span>(price_points))</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j, S <span class="kw">in</span> <span class="bu">enumerate</span>(price_points):</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>            current_values[j] <span class="op">=</span> <span class="va">self</span>.calendar_spread_value(S, sigma, <span class="va">self</span>.T1<span class="op">/</span><span class="dv">2</span>)  <span class="co"># Halfway to expiration</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].plot(price_points, current_values, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Halfway to Expiration'</span>)</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>        expiration_values <span class="op">=</span> np.zeros(<span class="bu">len</span>(price_points))</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j, S <span class="kw">in</span> <span class="bu">enumerate</span>(price_points):</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>            expiration_values[j] <span class="op">=</span> <span class="va">self</span>.calendar_spread_value(S, sigma, <span class="dv">0</span>)  <span class="co"># At expiration</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].plot(price_points, expiration_values, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'At Expiration'</span>)</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].axvline(x<span class="op">=</span><span class="va">self</span>.K, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'P&amp;L at Different Times'</span>)</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Stock Price ($)'</span>)</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'P&amp;L ($)'</span>)</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].legend()</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create calendar spread analyzer</span></span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>    analyzer <span class="op">=</span> CalendarSpreadAnalyzer(S0<span class="op">=</span><span class="dv">100</span>, K<span class="op">=</span><span class="dv">100</span>, T1<span class="op">=</span><span class="dv">30</span><span class="op">/</span><span class="dv">365</span>, T2<span class="op">=</span><span class="dv">60</span><span class="op">/</span><span class="dv">365</span>)</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot payoff diagram</span></span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>    analyzer.plot_payoff_diagram(sigma<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot Greeks evolution</span></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>    analyzer.plot_greeks_evolution(sigma<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="risk-management-dashboard" class="level3" data-number="12.4">
<h3 data-number="12.4" class="anchored" data-anchor-id="risk-management-dashboard"><span class="header-section-number">12.4</span> Risk Management Dashboard</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RiskManagementDashboard:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Comprehensive risk management dashboard for Sunny algorithm"""</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, portfolio_data: pd.DataFrame):</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.portfolio_data <span class="op">=</span> portfolio_data</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics <span class="op">=</span> {}</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_risk_metrics(<span class="va">self</span>):</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate comprehensive risk metrics"""</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        returns <span class="op">=</span> <span class="va">self</span>.portfolio_data[<span class="st">'returns'</span>]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        portfolio_value <span class="op">=</span> <span class="va">self</span>.portfolio_data[<span class="st">'portfolio_value'</span>]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic metrics</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'total_return'</span>] <span class="op">=</span> (portfolio_value.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">/</span> portfolio_value.iloc[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'annual_return'</span>] <span class="op">=</span> ((portfolio_value.iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">/</span> portfolio_value.iloc[<span class="dv">0</span>]) <span class="op">**</span> (<span class="dv">252</span><span class="op">/</span><span class="bu">len</span>(returns)) <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'volatility'</span>] <span class="op">=</span> returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'sharpe_ratio'</span>] <span class="op">=</span> <span class="va">self</span>.risk_metrics[<span class="st">'annual_return'</span>] <span class="op">/</span> <span class="va">self</span>.risk_metrics[<span class="st">'volatility'</span>] <span class="cf">if</span> <span class="va">self</span>.risk_metrics[<span class="st">'volatility'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Drawdown analysis</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        rolling_max <span class="op">=</span> portfolio_value.expanding().<span class="bu">max</span>()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (portfolio_value <span class="op">-</span> rolling_max) <span class="op">/</span> rolling_max <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'max_drawdown'</span>] <span class="op">=</span> <span class="bu">abs</span>(drawdown.<span class="bu">min</span>())</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'current_drawdown'</span>] <span class="op">=</span> <span class="bu">abs</span>(drawdown.iloc[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calmar ratio</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'calmar_ratio'</span>] <span class="op">=</span> <span class="va">self</span>.risk_metrics[<span class="st">'annual_return'</span>] <span class="op">/</span> <span class="va">self</span>.risk_metrics[<span class="st">'max_drawdown'</span>] <span class="cf">if</span> <span class="va">self</span>.risk_metrics[<span class="st">'max_drawdown'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Win rate analysis</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        winning_trades <span class="op">=</span> returns[returns <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        losing_trades <span class="op">=</span> returns[returns <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'win_rate'</span>] <span class="op">=</span> <span class="bu">len</span>(winning_trades) <span class="op">/</span> <span class="bu">len</span>(returns) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'avg_win'</span>] <span class="op">=</span> winning_trades.mean() <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> <span class="bu">len</span>(winning_trades) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'avg_loss'</span>] <span class="op">=</span> losing_trades.mean() <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> <span class="bu">len</span>(losing_trades) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'win_loss_ratio'</span>] <span class="op">=</span> <span class="bu">abs</span>(<span class="va">self</span>.risk_metrics[<span class="st">'avg_win'</span>] <span class="op">/</span> <span class="va">self</span>.risk_metrics[<span class="st">'avg_loss'</span>]) <span class="cf">if</span> <span class="va">self</span>.risk_metrics[<span class="st">'avg_loss'</span>] <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Value at Risk (VaR)</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'var_95'</span>] <span class="op">=</span> <span class="bu">abs</span>(np.percentile(returns, <span class="dv">5</span>)) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'var_99'</span>] <span class="op">=</span> <span class="bu">abs</span>(np.percentile(returns, <span class="dv">1</span>)) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Expected Shortfall (CVaR)</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        var_95_threshold <span class="op">=</span> np.percentile(returns, <span class="dv">5</span>)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        tail_losses <span class="op">=</span> returns[returns <span class="op">&lt;=</span> var_95_threshold]</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.risk_metrics[<span class="st">'cvar_95'</span>] <span class="op">=</span> <span class="bu">abs</span>(tail_losses.mean()) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> <span class="bu">len</span>(tail_losses) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.risk_metrics</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_performance_dashboard(<span class="va">self</span>):</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create comprehensive performance dashboard using Plotly"""</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate metrics first</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.calculate_risk_metrics()</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create subplots</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        fig <span class="op">=</span> make_subplots(</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            rows<span class="op">=</span><span class="dv">3</span>, cols<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>            subplot_titles<span class="op">=</span>(<span class="st">'Portfolio Value Evolution'</span>, <span class="st">'Daily Returns Distribution'</span>,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'Drawdown Analysis'</span>, <span class="st">'Rolling Risk Metrics'</span>,</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'Monthly Returns Heatmap'</span>, <span class="st">'Risk Metrics Summary'</span>),</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>            specs<span class="op">=</span>[[{<span class="st">"secondary_y"</span>: <span class="va">False</span>}, {<span class="st">"secondary_y"</span>: <span class="va">False</span>}],</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>                   [{<span class="st">"secondary_y"</span>: <span class="va">False</span>}, {<span class="st">"secondary_y"</span>: <span class="va">False</span>}],</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>                   [{<span class="st">"secondary_y"</span>: <span class="va">False</span>}, {<span class="st">"secondary_y"</span>: <span class="va">False</span>}]]</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Portfolio value evolution</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>            go.Scatter(x<span class="op">=</span><span class="va">self</span>.portfolio_data.index, </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>                      y<span class="op">=</span><span class="va">self</span>.portfolio_data[<span class="st">'portfolio_value'</span>],</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>                      mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'Portfolio Value'</span>,</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>                      line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'steelblue'</span>, width<span class="op">=</span><span class="dv">2</span>)),</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>            row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Returns distribution</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>            go.Histogram(x<span class="op">=</span><span class="va">self</span>.portfolio_data[<span class="st">'returns'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>                        nbinsx<span class="op">=</span><span class="dv">50</span>, name<span class="op">=</span><span class="st">'Daily Returns (%)'</span>,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>                        marker_color<span class="op">=</span><span class="st">'darkgreen'</span>, opacity<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>            row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">2</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Drawdown analysis</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        rolling_max <span class="op">=</span> <span class="va">self</span>.portfolio_data[<span class="st">'portfolio_value'</span>].expanding().<span class="bu">max</span>()</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (<span class="va">self</span>.portfolio_data[<span class="st">'portfolio_value'</span>] <span class="op">-</span> rolling_max) <span class="op">/</span> rolling_max <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>            go.Scatter(x<span class="op">=</span><span class="va">self</span>.portfolio_data.index, y<span class="op">=</span>drawdown,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>                      mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'Drawdown (%)'</span>,</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>                      fill<span class="op">=</span><span class="st">'tonexty'</span>, fillcolor<span class="op">=</span><span class="st">'rgba(255,0,0,0.3)'</span>,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>                      line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>, width<span class="op">=</span><span class="dv">1</span>)),</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>            row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rolling metrics</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        window <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        rolling_sharpe <span class="op">=</span> (<span class="va">self</span>.portfolio_data[<span class="st">'returns'</span>].rolling(window).mean() <span class="op">*</span> <span class="dv">252</span>) <span class="op">/</span> <span class="op">\</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>                        (<span class="va">self</span>.portfolio_data[<span class="st">'returns'</span>].rolling(window).std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>))</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>        rolling_vol <span class="op">=</span> <span class="va">self</span>.portfolio_data[<span class="st">'returns'</span>].rolling(window).std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>            go.Scatter(x<span class="op">=</span><span class="va">self</span>.portfolio_data.index, y<span class="op">=</span>rolling_sharpe,</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>                      mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'60-Day Sharpe Ratio'</span>,</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>                      line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'purple'</span>, width<span class="op">=</span><span class="dv">2</span>)),</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>            row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">2</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Monthly returns heatmap (simplified representation)</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.portfolio_data) <span class="op">&gt;</span> <span class="dv">30</span>:</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>            monthly_returns <span class="op">=</span> <span class="va">self</span>.portfolio_data[<span class="st">'returns'</span>].resample(<span class="st">'M'</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: (<span class="dv">1</span> <span class="op">+</span> x).prod() <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>            years <span class="op">=</span> monthly_returns.index.year.unique()</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>            months <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create matrix for heatmap</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>            heatmap_data <span class="op">=</span> np.full((<span class="bu">len</span>(years), <span class="dv">12</span>), np.nan)</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, year <span class="kw">in</span> <span class="bu">enumerate</span>(years):</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>                year_data <span class="op">=</span> monthly_returns[monthly_returns.index.year <span class="op">==</span> year]</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> month_data <span class="kw">in</span> year_data.iteritems():</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>                    month <span class="op">=</span> month_data[<span class="dv">0</span>].month</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>                    heatmap_data[i, month<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> month_data[<span class="dv">1</span>]</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>            fig.add_trace(</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>                go.Heatmap(z<span class="op">=</span>heatmap_data, </span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>                          x<span class="op">=</span>[<span class="ss">f'M</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)],</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>                          y<span class="op">=</span>years,</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>                          colorscale<span class="op">=</span><span class="st">'RdYlGn'</span>,</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>                          name<span class="op">=</span><span class="st">'Monthly Returns (%)'</span>),</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>                row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">1</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Risk metrics summary table</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>        metrics_data <span class="op">=</span> [</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>            [<span class="st">'Annual Return'</span>, <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'annual_return'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>],</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>            [<span class="st">'Volatility'</span>, <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'volatility'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>],</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>            [<span class="st">'Sharpe Ratio'</span>, <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'sharpe_ratio'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>],</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>            [<span class="st">'Max Drawdown'</span>, <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'max_drawdown'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>],</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>            [<span class="st">'Win Rate'</span>, <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'win_rate'</span>]<span class="sc">:.1f}</span><span class="ss">%"</span>],</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>            [<span class="st">'VaR 95%'</span>, <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'var_95'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>]</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>            go.Table(</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>                header<span class="op">=</span><span class="bu">dict</span>(values<span class="op">=</span>[<span class="st">'Metric'</span>, <span class="st">'Value'</span>],</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>                           fill_color<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>                           align<span class="op">=</span><span class="st">'left'</span>),</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>                cells<span class="op">=</span><span class="bu">dict</span>(values<span class="op">=</span><span class="bu">list</span>(<span class="bu">zip</span>(<span class="op">*</span>metrics_data)),</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>                          fill_color<span class="op">=</span><span class="st">'white'</span>,</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>                          align<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>            row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">2</span></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update layout</span></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>        fig.update_layout(</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>            height<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>            title_text<span class="op">=</span><span class="st">"Sunny Algorithm Risk Management Dashboard"</span>,</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>            title_x<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>            showlegend<span class="op">=</span><span class="va">True</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update axes labels</span></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>        fig.update_xaxes(title_text<span class="op">=</span><span class="st">"Date"</span>, row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>        fig.update_yaxes(title_text<span class="op">=</span><span class="st">"Portfolio Value ($)"</span>, row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>        fig.update_xaxes(title_text<span class="op">=</span><span class="st">"Daily Return (%)"</span>, row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>        fig.update_yaxes(title_text<span class="op">=</span><span class="st">"Frequency"</span>, row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>        fig.update_xaxes(title_text<span class="op">=</span><span class="st">"Date"</span>, row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>        fig.update_yaxes(title_text<span class="op">=</span><span class="st">"Drawdown (%)"</span>, row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>        fig.update_xaxes(title_text<span class="op">=</span><span class="st">"Date"</span>, row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>        fig.update_yaxes(title_text<span class="op">=</span><span class="st">"Sharpe Ratio"</span>, row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fig</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_position_level_analysis(<span class="va">self</span>, positions_data: pd.DataFrame):</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Analyze individual position performance"""</span></span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position P&amp;L distribution</span></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>        plt.hist(positions_data[<span class="st">'pnl_pct'</span>], bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'P&amp;L (%)'</span>)</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Position P&amp;L Distribution'</span>)</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Win rate by holding period</span></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>        positions_data[<span class="st">'holding_period_bins'</span>] <span class="op">=</span> pd.cut(positions_data[<span class="st">'holding_days'</span>], </span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>                                                      bins<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">7</span>, <span class="dv">14</span>, <span class="dv">21</span>, <span class="dv">30</span>, <span class="bu">float</span>(<span class="st">'inf'</span>)],</span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>                                                      labels<span class="op">=</span>[<span class="st">'1-7'</span>, <span class="st">'8-14'</span>, <span class="st">'15-21'</span>, <span class="st">'22-30'</span>, <span class="st">'30+'</span>])</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>        win_rate_by_period <span class="op">=</span> positions_data.groupby(<span class="st">'holding_period_bins'</span>)[<span class="st">'pnl_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="dv">0</span>).mean() <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>        plt.bar(<span class="bu">range</span>(<span class="bu">len</span>(win_rate_by_period)), win_rate_by_period.values, color<span class="op">=</span><span class="st">'darkgreen'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Holding Period (Days)'</span>)</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Win Rate (%)'</span>)</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Win Rate by Holding Period'</span>)</span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>        plt.xticks(<span class="bu">range</span>(<span class="bu">len</span>(win_rate_by_period)), win_rate_by_period.index)</span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>        <span class="co"># P&amp;L vs IV Rank</span></span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>        plt.scatter(positions_data[<span class="st">'iv_rank'</span>], positions_data[<span class="st">'pnl_pct'</span>], alpha<span class="op">=</span><span class="fl">0.6</span>, color<span class="op">=</span><span class="st">'purple'</span>)</span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'IV Rank at Entry'</span>)</span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'P&amp;L (%)'</span>)</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'P&amp;L vs IV Rank'</span>)</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Monthly win rate</span></span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>        positions_data[<span class="st">'entry_month'</span>] <span class="op">=</span> pd.to_datetime(positions_data[<span class="st">'entry_date'</span>]).dt.month</span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>        monthly_win_rate <span class="op">=</span> positions_data.groupby(<span class="st">'entry_month'</span>)[<span class="st">'pnl_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="dv">0</span>).mean() <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>        months <span class="op">=</span> [<span class="st">'Jan'</span>, <span class="st">'Feb'</span>, <span class="st">'Mar'</span>, <span class="st">'Apr'</span>, <span class="st">'May'</span>, <span class="st">'Jun'</span>, </span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'Jul'</span>, <span class="st">'Aug'</span>, <span class="st">'Sep'</span>, <span class="st">'Oct'</span>, <span class="st">'Nov'</span>, <span class="st">'Dec'</span>]</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>        plt.bar(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>), [monthly_win_rate.get(i, <span class="dv">0</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)], </span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Month'</span>)</span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Win Rate (%)'</span>)</span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Seasonal Win Rate Pattern'</span>)</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>        plt.xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>), [months[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">12</span>)], rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cumulative P&amp;L</span></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>        positions_data_sorted <span class="op">=</span> positions_data.sort_values(<span class="st">'entry_date'</span>)</span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>        cumulative_pnl <span class="op">=</span> positions_data_sorted[<span class="st">'pnl_dollars'</span>].cumsum()</span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(cumulative_pnl)), cumulative_pnl, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'navy'</span>)</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Trade Number'</span>)</span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Cumulative P&amp;L ($)'</span>)</span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Cumulative P&amp;L by Trade'</span>)</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Risk-adjusted returns by volatility regime</span></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">6</span>)</span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>        positions_data[<span class="st">'vol_regime'</span>] <span class="op">=</span> pd.cut(positions_data[<span class="st">'vix_at_entry'</span>], </span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>                                            bins<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">15</span>, <span class="dv">25</span>, <span class="bu">float</span>(<span class="st">'inf'</span>)],</span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>                                            labels<span class="op">=</span>[<span class="st">'Low Vol'</span>, <span class="st">'Normal Vol'</span>, <span class="st">'High Vol'</span>])</span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>        vol_regime_returns <span class="op">=</span> positions_data.groupby(<span class="st">'vol_regime'</span>)[<span class="st">'pnl_pct'</span>].mean()</span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>        colors <span class="op">=</span> [<span class="st">'green'</span>, <span class="st">'yellow'</span>, <span class="st">'red'</span>]</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>        plt.bar(<span class="bu">range</span>(<span class="bu">len</span>(vol_regime_returns)), vol_regime_returns.values, </span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Volatility Regime'</span>)</span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Average P&amp;L (%)'</span>)</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Performance by Vol Regime'</span>)</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>        plt.xticks(<span class="bu">range</span>(<span class="bu">len</span>(vol_regime_returns)), vol_regime_returns.index)</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>        plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_risk_report(<span class="va">self</span>):</span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate comprehensive risk report"""</span></span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.calculate_risk_metrics()</span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Sunny ALGORITHM RISK MANAGEMENT REPORT"</span>)</span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Report Generated: </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"PERFORMANCE SUMMARY"</span>)</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">30</span>)</span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total Return:           </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'total_return'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Annualized Return:      </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'annual_return'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Annualized Volatility:  </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'volatility'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Sharpe Ratio:           </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'sharpe_ratio'</span>]<span class="sc">:8.2f}</span><span class="ss">"</span>)</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Calmar Ratio:           </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'calmar_ratio'</span>]<span class="sc">:8.2f}</span><span class="ss">"</span>)</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"RISK METRICS"</span>)</span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">30</span>)</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Maximum Drawdown:       </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'max_drawdown'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Current Drawdown:       </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'current_drawdown'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"VaR (95%):             </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'var_95'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"VaR (99%):             </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'var_99'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"CVaR (95%):            </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'cvar_95'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"TRADE STATISTICS"</span>)</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">30</span>)</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Win Rate:               </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'win_rate'</span>]<span class="sc">:8.1f}</span><span class="ss">%"</span>)</span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Average Win:            </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'avg_win'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Average Loss:           </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'avg_loss'</span>]<span class="sc">:8.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Win/Loss Ratio:         </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>risk_metrics[<span class="st">'win_loss_ratio'</span>]<span class="sc">:8.2f}</span><span class="ss">"</span>)</span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Risk assessment</span></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"RISK ASSESSMENT"</span>)</span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">30</span>)</span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>        risk_level <span class="op">=</span> <span class="st">"LOW"</span></span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.risk_metrics[<span class="st">'max_drawdown'</span>] <span class="op">&gt;</span> <span class="dv">15</span>:</span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>            risk_level <span class="op">=</span> <span class="st">"HIGH"</span></span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.risk_metrics[<span class="st">'max_drawdown'</span>] <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>            risk_level <span class="op">=</span> <span class="st">"MODERATE"</span></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Overall Risk Level:     </span><span class="sc">{</span>risk_level<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.risk_metrics[<span class="st">'current_drawdown'</span>] <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"⚠️  WARNING: Current drawdown exceeds 5%"</span>)</span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.risk_metrics[<span class="st">'sharpe_ratio'</span>] <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"⚠️  WARNING: Sharpe ratio below 1.0"</span>)</span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.risk_metrics[<span class="st">'win_rate'</span>] <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"⚠️  WARNING: Win rate below 50%"</span>)</span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Utility function to generate sample data</span></span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_sample_portfolio_data(days: <span class="bu">int</span> <span class="op">=</span> <span class="dv">252</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate sample portfolio data for dashboard testing"""</span></span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start<span class="op">=</span><span class="st">'2023-01-01'</span>, periods<span class="op">=</span>days, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate portfolio with volatility selling characteristics</span></span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Positive skew, occasional larger losses</span></span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>    base_return <span class="op">=</span> <span class="fl">0.0008</span>  <span class="co"># Positive expected return</span></span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>    vol <span class="op">=</span> <span class="fl">0.015</span>  <span class="co"># Moderate volatility</span></span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> np.random.normal(base_return, vol, days)</span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add occasional larger losses (tail events)</span></span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>    tail_events <span class="op">=</span> np.random.random(days) <span class="op">&lt;</span> <span class="fl">0.02</span>  <span class="co"># 2% chance</span></span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a>    returns[tail_events] <span class="op">=</span> np.random.normal(<span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0.02</span>, np.<span class="bu">sum</span>(tail_events))</span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate portfolio values</span></span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>    portfolio_values <span class="op">=</span> [<span class="dv">100000</span>]  <span class="co"># Starting value</span></span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ret <span class="kw">in</span> returns[<span class="dv">1</span>:]:</span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>        portfolio_values.append(portfolio_values[<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> ret))</span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>    portfolio_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a>        <span class="st">'portfolio_value'</span>: portfolio_values,</span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>        <span class="st">'returns'</span>: returns</span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>dates)</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolio_data</span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_sample_positions_data(n_positions: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate sample positions data for analysis"""</span></span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate random position data</span></span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>    entry_dates <span class="op">=</span> pd.date_range(start<span class="op">=</span><span class="st">'2023-01-01'</span>, periods<span class="op">=</span>n_positions, freq<span class="op">=</span><span class="st">'3D'</span>)</span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a>    holding_days <span class="op">=</span> np.random.randint(<span class="dv">1</span>, <span class="dv">30</span>, n_positions)</span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>    <span class="co"># P&amp;L with positive skew (characteristic of volatility selling)</span></span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a>    pnl_pct <span class="op">=</span> np.random.beta(<span class="dv">2</span>, <span class="dv">5</span>, n_positions) <span class="op">*</span> <span class="dv">15</span> <span class="op">-</span> <span class="dv">2</span>  <span class="co"># Slightly positive bias</span></span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a>    pnl_dollars <span class="op">=</span> pnl_pct <span class="op">*</span> np.random.uniform(<span class="dv">1000</span>, <span class="dv">5000</span>, n_positions) <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other characteristics</span></span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>    iv_rank <span class="op">=</span> np.random.uniform(<span class="dv">20</span>, <span class="dv">90</span>, n_positions)</span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>    vix_at_entry <span class="op">=</span> np.random.gamma(<span class="dv">2</span>, <span class="dv">8</span>, n_positions) <span class="op">+</span> <span class="dv">12</span>  <span class="co"># VIX-like distribution</span></span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>    positions_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a>        <span class="st">'entry_date'</span>: entry_dates,</span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>        <span class="st">'holding_days'</span>: holding_days,</span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pnl_pct'</span>: pnl_pct,</span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pnl_dollars'</span>: pnl_dollars,</span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iv_rank'</span>: iv_rank,</span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>        <span class="st">'vix_at_entry'</span>: vix_at_entry</span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> positions_data</span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate sample data</span></span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>    portfolio_data <span class="op">=</span> generate_sample_portfolio_data(<span class="dv">365</span>)</span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a>    positions_data <span class="op">=</span> generate_sample_positions_data(<span class="dv">150</span>)</span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create dashboard</span></span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a>    dashboard <span class="op">=</span> RiskManagementDashboard(portfolio_data)</span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate risk report</span></span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>    dashboard.generate_risk_report()</span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create interactive dashboard (requires plotly)</span></span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fig = dashboard.create_performance_dashboard()</span></span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fig.show()</span></span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create position analysis</span></span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>    dashboard.plot_position_level_analysis(positions_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="kelly-criterion-position-sizing-implementation" class="level3" data-number="12.5">
<h3 data-number="12.5" class="anchored" data-anchor-id="kelly-criterion-position-sizing-implementation"><span class="header-section-number">12.5</span> Kelly Criterion Position Sizing Implementation</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize_scalar</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple, Optional</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> KellyOptimizer:</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Kelly Criterion position sizing for options strategies"""</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, returns_data: pd.Series):</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.returns_data <span class="op">=</span> returns_data</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kelly_results <span class="op">=</span> {}</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_empirical_kelly(<span class="va">self</span>, fractional: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.25</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate Kelly fraction using empirical return distribution"""</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        returns <span class="op">=</span> <span class="va">self</span>.returns_data.dropna()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(returns) <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">'kelly_fraction'</span>: <span class="dv">0</span>, <span class="st">'fractional_kelly'</span>: <span class="dv">0</span>, <span class="st">'valid'</span>: <span class="va">False</span>}</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate parameters from data</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        win_rate <span class="op">=</span> (returns <span class="op">&gt;</span> <span class="dv">0</span>).mean()</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        avg_win <span class="op">=</span> returns[returns <span class="op">&gt;</span> <span class="dv">0</span>].mean() <span class="cf">if</span> win_rate <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        avg_loss <span class="op">=</span> <span class="bu">abs</span>(returns[returns <span class="op">&lt;</span> <span class="dv">0</span>].mean()) <span class="cf">if</span> win_rate <span class="op">&lt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classical Kelly for binary outcomes</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> avg_loss <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            b <span class="op">=</span> avg_win <span class="op">/</span> avg_loss  <span class="co"># Win/loss ratio</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            kelly_fraction <span class="op">=</span> (win_rate <span class="op">*</span> b <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> win_rate)) <span class="op">/</span> b</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            kelly_fraction <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure non-negative</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        kelly_fraction <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, kelly_fraction)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply fractional sizing</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        fractional_kelly <span class="op">=</span> kelly_fraction <span class="op">*</span> fractional</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'kelly_fraction'</span>: kelly_fraction,</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">'fractional_kelly'</span>: fractional_kelly,</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">'win_rate'</span>: win_rate,</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">'avg_win'</span>: avg_win,</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">'avg_loss'</span>: avg_loss,</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">'win_loss_ratio'</span>: avg_win <span class="op">/</span> avg_loss <span class="cf">if</span> avg_loss <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'valid'</span>: <span class="va">True</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimize_continuous_kelly(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Optimize Kelly fraction for continuous return distribution"""</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> negative_log_utility(f):</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""Negative expected log utility for minimization"""</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> f <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> f <span class="op">&gt;=</span> <span class="dv">1</span>:</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fl">1e6</span>  <span class="co"># Penalty for invalid fractions</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>            log_utilities <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> f <span class="op">*</span> <span class="va">self</span>.returns_data)</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check for negative values (bankruptcy)</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> np.<span class="bu">any</span>(<span class="dv">1</span> <span class="op">+</span> f <span class="op">*</span> <span class="va">self</span>.returns_data <span class="op">&lt;=</span> <span class="dv">0</span>):</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fl">1e6</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="op">-</span>np.mean(log_utilities)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Optimize over reasonable range</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> minimize_scalar(negative_log_utility, bounds<span class="op">=</span>(<span class="fl">0.001</span>, <span class="fl">0.999</span>), method<span class="op">=</span><span class="st">'bounded'</span>)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result.success:</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>            optimal_f <span class="op">=</span> result.x</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>            expected_log_utility <span class="op">=</span> <span class="op">-</span>result.fun</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            optimal_f <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>            expected_log_utility <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">'optimal_fraction'</span>: optimal_f,</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expected_log_utility'</span>: expected_log_utility,</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>            <span class="st">'optimization_success'</span>: result.success</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> simulate_kelly_performance(<span class="va">self</span>, fractions: <span class="bu">list</span>, n_simulations: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1000</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Simulate portfolio growth under different Kelly fractions"""</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> fractions:</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>            final_values <span class="op">=</span> []</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_simulations):</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Bootstrap sample from returns</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>                simulated_returns <span class="op">=</span> np.random.choice(<span class="va">self</span>.returns_data, <span class="bu">len</span>(<span class="va">self</span>.returns_data), replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate final portfolio value</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>                portfolio_value <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> ret <span class="kw">in</span> simulated_returns:</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>                    portfolio_value <span class="op">*=</span> (<span class="dv">1</span> <span class="op">+</span> f <span class="op">*</span> ret)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> portfolio_value <span class="op">&lt;=</span> <span class="dv">0</span>:  <span class="co"># Bankruptcy</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>                        portfolio_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>                final_values.append(portfolio_value)</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate statistics</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>            final_values <span class="op">=</span> np.array(final_values)</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>            bankruptcy_rate <span class="op">=</span> np.mean(final_values <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> bankruptcy_rate <span class="op">&lt;</span> <span class="fl">1.0</span>:  <span class="co"># Exclude bankrupt scenarios for statistics</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>                non_bankrupt <span class="op">=</span> final_values[final_values <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>                geometric_mean <span class="op">=</span> np.exp(np.mean(np.log(non_bankrupt))) <span class="cf">if</span> <span class="bu">len</span>(non_bankrupt) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>                median_return <span class="op">=</span> np.median(non_bankrupt) <span class="cf">if</span> <span class="bu">len</span>(non_bankrupt) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>                percentile_5 <span class="op">=</span> np.percentile(non_bankrupt, <span class="dv">5</span>) <span class="cf">if</span> <span class="bu">len</span>(non_bankrupt) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>                geometric_mean <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>                median_return <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>                percentile_5 <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>            results.append({</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fraction'</span>: f,</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>                <span class="st">'geometric_mean'</span>: geometric_mean,</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>                <span class="st">'median_return'</span>: median_return,</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>                <span class="st">'percentile_5'</span>: percentile_5,</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>                <span class="st">'bankruptcy_rate'</span>: bankruptcy_rate,</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>                <span class="st">'max_return'</span>: np.<span class="bu">max</span>(final_values),</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>                <span class="st">'min_return'</span>: np.<span class="bu">min</span>(final_values[final_values <span class="op">&gt;</span> <span class="dv">0</span>]) <span class="cf">if</span> np.<span class="bu">any</span>(final_values <span class="op">&gt;</span> <span class="dv">0</span>) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_kelly_analysis(<span class="va">self</span>):</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create comprehensive Kelly analysis visualization"""</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate Kelly metrics</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>        empirical_kelly <span class="op">=</span> <span class="va">self</span>.calculate_empirical_kelly()</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>        continuous_kelly <span class="op">=</span> <span class="va">self</span>.optimize_continuous_kelly()</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Test different fractions</span></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>        test_fractions <span class="op">=</span> np.linspace(<span class="fl">0.01</span>, <span class="fl">0.8</span>, <span class="dv">20</span>)</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>        simulation_results <span class="op">=</span> <span class="va">self</span>.simulate_kelly_performance(test_fractions, <span class="dv">1000</span>)</span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create subplots</span></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">12</span>))</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(<span class="st">'Kelly Criterion Analysis for Sunny Algorithm'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot 1: Geometric mean return vs fraction</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].plot(simulation_results[<span class="st">'fraction'</span>], simulation_results[<span class="st">'geometric_mean'</span>], </span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'b-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Geometric Mean Return'</span>)</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].axvline(x<span class="op">=</span>empirical_kelly[<span class="st">'kelly_fraction'</span>], color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>                          label<span class="op">=</span><span class="ss">f'Empirical Kelly: </span><span class="sc">{</span>empirical_kelly[<span class="st">"kelly_fraction"</span>]<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].axvline(x<span class="op">=</span>empirical_kelly[<span class="st">'fractional_kelly'</span>], color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>                          label<span class="op">=</span><span class="ss">f'Fractional Kelly (25%): </span><span class="sc">{</span>empirical_kelly[<span class="st">"fractional_kelly"</span>]<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Position Fraction'</span>)</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Geometric Mean Return'</span>)</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Optimal Position Sizing'</span>)</span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].legend()</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot 2: Bankruptcy risk</span></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].plot(simulation_results[<span class="st">'fraction'</span>], simulation_results[<span class="st">'bankruptcy_rate'</span>] <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'r-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Position Fraction'</span>)</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Bankruptcy Rate (%)'</span>)</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Risk of Ruin'</span>)</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot 3: Return distribution for different fractions</span></span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>        key_fractions <span class="op">=</span> [<span class="fl">0.1</span>, empirical_kelly[<span class="st">'fractional_kelly'</span>], empirical_kelly[<span class="st">'kelly_fraction'</span>]]</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>        colors <span class="op">=</span> [<span class="st">'blue'</span>, <span class="st">'orange'</span>, <span class="st">'red'</span>]</span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> [<span class="st">'Conservative (10%)'</span>, <span class="st">'Fractional Kelly'</span>, <span class="st">'Full Kelly'</span>]</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (f, color, label) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(key_fractions, colors, labels)):</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> f <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Simulate returns for this fraction</span></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>                portfolio_values <span class="op">=</span> []</span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>                    simulated_returns <span class="op">=</span> np.random.choice(<span class="va">self</span>.returns_data, <span class="bu">len</span>(<span class="va">self</span>.returns_data), replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>                    portfolio_value <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> ret <span class="kw">in</span> simulated_returns:</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>                        portfolio_value <span class="op">*=</span> (<span class="dv">1</span> <span class="op">+</span> f <span class="op">*</span> ret)</span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> portfolio_value <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>                            portfolio_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>                    portfolio_values.append(portfolio_value)</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Plot distribution</span></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>                portfolio_values <span class="op">=</span> np.array(portfolio_values)</span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>                portfolio_values <span class="op">=</span> portfolio_values[portfolio_values <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="co"># Remove bankruptcies</span></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(portfolio_values) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>                    axes[<span class="dv">1</span>, <span class="dv">0</span>].hist(portfolio_values, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, color<span class="op">=</span>color, </span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>                                   label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> (f=</span><span class="sc">{</span>f<span class="sc">:.3f}</span><span class="ss">)'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Final Portfolio Value'</span>)</span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Final Portfolio Value Distributions'</span>)</span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].legend()</span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot 4: Risk-return tradeoff</span></span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].scatter(simulation_results[<span class="st">'bankruptcy_rate'</span>] <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>                          simulation_results[<span class="st">'geometric_mean'</span>], </span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>                          c<span class="op">=</span>simulation_results[<span class="st">'fraction'</span>], cmap<span class="op">=</span><span class="st">'viridis'</span>, s<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Highlight key points</span></span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>        optimal_idx <span class="op">=</span> simulation_results[<span class="st">'geometric_mean'</span>].idxmax()</span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].scatter(simulation_results.loc[optimal_idx, <span class="st">'bankruptcy_rate'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>                          simulation_results.loc[optimal_idx, <span class="st">'geometric_mean'</span>],</span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>                          color<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">100</span>, marker<span class="op">=</span><span class="st">'*'</span>, label<span class="op">=</span><span class="st">'Optimal Kelly'</span>)</span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Bankruptcy Rate (%)'</span>)</span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Geometric Mean Return'</span>)</span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Risk-Return Tradeoff'</span>)</span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].legend()</span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add colorbar</span></span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>        cbar <span class="op">=</span> plt.colorbar(axes[<span class="dv">1</span>, <span class="dv">1</span>].collections[<span class="dv">0</span>], ax<span class="op">=</span>axes[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>        cbar.set_label(<span class="st">'Position Fraction'</span>)</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print summary</span></span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">KELLY CRITERION ANALYSIS SUMMARY"</span>)</span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Empirical Kelly Fraction:    </span><span class="sc">{</span>empirical_kelly[<span class="st">'kelly_fraction'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Recommended Fractional Kelly: </span><span class="sc">{</span>empirical_kelly[<span class="st">'fractional_kelly'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Win Rate:                    </span><span class="sc">{</span>empirical_kelly[<span class="st">'win_rate'</span>]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Average Win:                 </span><span class="sc">{</span>empirical_kelly[<span class="st">'avg_win'</span>]<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Average Loss:                </span><span class="sc">{</span>empirical_kelly[<span class="st">'avg_loss'</span>]<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Win/Loss Ratio:              </span><span class="sc">{</span>empirical_kelly[<span class="st">'win_loss_ratio'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> empirical_kelly, simulation_results</span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Position sizing implementation for Sunny algorithm</span></span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SunnyPositionSizer:</span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Position sizing implementation for Sunny algorithm"""</span></span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, portfolio_value: <span class="bu">float</span>, allocation_fraction: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.06</span>):</span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.portfolio_value <span class="op">=</span> portfolio_value</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.allocation_fraction <span class="op">=</span> allocation_fraction</span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.commission_per_contract <span class="op">=</span> <span class="fl">0.65</span></span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_commission <span class="op">=</span> <span class="fl">1.00</span></span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.slippage_factor <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-246"><a href="#cb5-246" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_position_size(<span class="va">self</span>, calendar_debit: <span class="bu">float</span>, </span>
<span id="cb5-247"><a href="#cb5-247" aria-hidden="true" tabindex="-1"></a>                              option_multiplier: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb5-248"><a href="#cb5-248" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate optimal position size for calendar spread"""</span></span>
<span id="cb5-249"><a href="#cb5-249" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-250"><a href="#cb5-250" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Maximum risk amount per trade</span></span>
<span id="cb5-251"><a href="#cb5-251" aria-hidden="true" tabindex="-1"></a>        max_risk <span class="op">=</span> <span class="va">self</span>.portfolio_value <span class="op">*</span> <span class="va">self</span>.allocation_fraction</span>
<span id="cb5-252"><a href="#cb5-252" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-253"><a href="#cb5-253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate total transaction costs per contract</span></span>
<span id="cb5-254"><a href="#cb5-254" aria-hidden="true" tabindex="-1"></a>        total_commission <span class="op">=</span> <span class="bu">max</span>(<span class="dv">4</span> <span class="op">*</span> <span class="va">self</span>.commission_per_contract, <span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.min_commission)</span>
<span id="cb5-255"><a href="#cb5-255" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-256"><a href="#cb5-256" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate slippage (percentage of spread)</span></span>
<span id="cb5-257"><a href="#cb5-257" aria-hidden="true" tabindex="-1"></a>        estimated_slippage <span class="op">=</span> calendar_debit <span class="op">*</span> <span class="va">self</span>.slippage_factor</span>
<span id="cb5-258"><a href="#cb5-258" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-259"><a href="#cb5-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Total cost per contract</span></span>
<span id="cb5-260"><a href="#cb5-260" aria-hidden="true" tabindex="-1"></a>        cost_per_contract <span class="op">=</span> (calendar_debit <span class="op">*</span> option_multiplier <span class="op">+</span> </span>
<span id="cb5-261"><a href="#cb5-261" aria-hidden="true" tabindex="-1"></a>                           total_commission <span class="op">+</span> </span>
<span id="cb5-262"><a href="#cb5-262" aria-hidden="true" tabindex="-1"></a>                           estimated_slippage <span class="op">*</span> option_multiplier)</span>
<span id="cb5-263"><a href="#cb5-263" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-264"><a href="#cb5-264" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate maximum quantity</span></span>
<span id="cb5-265"><a href="#cb5-265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cost_per_contract <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-266"><a href="#cb5-266" aria-hidden="true" tabindex="-1"></a>            max_quantity <span class="op">=</span> <span class="bu">int</span>(max_risk <span class="op">/</span> cost_per_contract)</span>
<span id="cb5-267"><a href="#cb5-267" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-268"><a href="#cb5-268" aria-hidden="true" tabindex="-1"></a>            max_quantity <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-269"><a href="#cb5-269" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Minimum position size for commission efficiency</span></span>
<span id="cb5-271"><a href="#cb5-271" aria-hidden="true" tabindex="-1"></a>        min_efficient_quantity <span class="op">=</span> <span class="dv">5</span> <span class="cf">if</span> <span class="va">self</span>.portfolio_value <span class="op">&gt;</span> <span class="dv">50000</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb5-272"><a href="#cb5-272" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-273"><a href="#cb5-273" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Final position size</span></span>
<span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a>        position_size <span class="op">=</span> <span class="bu">max</span>(min_efficient_quantity, max_quantity) <span class="cf">if</span> max_quantity <span class="op">&gt;=</span> min_efficient_quantity <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-275"><a href="#cb5-275" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-276"><a href="#cb5-276" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure we have enough cash (with buffer)</span></span>
<span id="cb5-277"><a href="#cb5-277" aria-hidden="true" tabindex="-1"></a>        required_cash <span class="op">=</span> cost_per_contract <span class="op">*</span> position_size</span>
<span id="cb5-278"><a href="#cb5-278" aria-hidden="true" tabindex="-1"></a>        available_cash <span class="op">=</span> <span class="va">self</span>.portfolio_value <span class="op">*</span> <span class="fl">0.8</span>  <span class="co"># 80% utilization limit</span></span>
<span id="cb5-279"><a href="#cb5-279" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-280"><a href="#cb5-280" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> required_cash <span class="op">&gt;</span> available_cash:</span>
<span id="cb5-281"><a href="#cb5-281" aria-hidden="true" tabindex="-1"></a>            position_size <span class="op">=</span> <span class="bu">int</span>(available_cash <span class="op">/</span> cost_per_contract)</span>
<span id="cb5-282"><a href="#cb5-282" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-283"><a href="#cb5-283" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb5-284"><a href="#cb5-284" aria-hidden="true" tabindex="-1"></a>            <span class="st">'position_size'</span>: position_size,</span>
<span id="cb5-285"><a href="#cb5-285" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cost_per_contract'</span>: cost_per_contract,</span>
<span id="cb5-286"><a href="#cb5-286" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_cost'</span>: cost_per_contract <span class="op">*</span> position_size,</span>
<span id="cb5-287"><a href="#cb5-287" aria-hidden="true" tabindex="-1"></a>            <span class="st">'portfolio_allocation'</span>: (cost_per_contract <span class="op">*</span> position_size) <span class="op">/</span> <span class="va">self</span>.portfolio_value <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb5-288"><a href="#cb5-288" aria-hidden="true" tabindex="-1"></a>            <span class="st">'commission_per_contract'</span>: total_commission,</span>
<span id="cb5-289"><a href="#cb5-289" aria-hidden="true" tabindex="-1"></a>            <span class="st">'slippage_estimate'</span>: estimated_slippage <span class="op">*</span> option_multiplier,</span>
<span id="cb5-290"><a href="#cb5-290" aria-hidden="true" tabindex="-1"></a>            <span class="st">'efficient_sizing'</span>: position_size <span class="op">&gt;=</span> min_efficient_quantity</span>
<span id="cb5-291"><a href="#cb5-291" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-292"><a href="#cb5-292" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-293"><a href="#cb5-293" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_position_sizing_analysis(<span class="va">self</span>, debit_range: np.array):</span>
<span id="cb5-294"><a href="#cb5-294" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Analyze position sizing across different debit levels"""</span></span>
<span id="cb5-295"><a href="#cb5-295" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-296"><a href="#cb5-296" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb5-297"><a href="#cb5-297" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> debit <span class="kw">in</span> debit_range:</span>
<span id="cb5-298"><a href="#cb5-298" aria-hidden="true" tabindex="-1"></a>            sizing <span class="op">=</span> <span class="va">self</span>.calculate_position_size(debit)</span>
<span id="cb5-299"><a href="#cb5-299" aria-hidden="true" tabindex="-1"></a>            results.append({</span>
<span id="cb5-300"><a href="#cb5-300" aria-hidden="true" tabindex="-1"></a>                <span class="st">'debit'</span>: debit,</span>
<span id="cb5-301"><a href="#cb5-301" aria-hidden="true" tabindex="-1"></a>                <span class="st">'position_size'</span>: sizing[<span class="st">'position_size'</span>],</span>
<span id="cb5-302"><a href="#cb5-302" aria-hidden="true" tabindex="-1"></a>                <span class="st">'total_cost'</span>: sizing[<span class="st">'total_cost'</span>],</span>
<span id="cb5-303"><a href="#cb5-303" aria-hidden="true" tabindex="-1"></a>                <span class="st">'allocation_pct'</span>: sizing[<span class="st">'portfolio_allocation'</span>],</span>
<span id="cb5-304"><a href="#cb5-304" aria-hidden="true" tabindex="-1"></a>                <span class="st">'cost_per_contract'</span>: sizing[<span class="st">'cost_per_contract'</span>]</span>
<span id="cb5-305"><a href="#cb5-305" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb5-306"><a href="#cb5-306" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-307"><a href="#cb5-307" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb5-308"><a href="#cb5-308" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-309"><a href="#cb5-309" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create visualization</span></span>
<span id="cb5-310"><a href="#cb5-310" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb5-311"><a href="#cb5-311" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(<span class="st">'Position Sizing Analysis'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb5-312"><a href="#cb5-312" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-313"><a href="#cb5-313" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position size vs debit</span></span>
<span id="cb5-314"><a href="#cb5-314" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].plot(df[<span class="st">'debit'</span>], df[<span class="st">'position_size'</span>], <span class="st">'b-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-315"><a href="#cb5-315" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Calendar Spread Debit ($)'</span>)</span>
<span id="cb5-316"><a href="#cb5-316" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Position Size (Contracts)'</span>)</span>
<span id="cb5-317"><a href="#cb5-317" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Position Size vs Debit Cost'</span>)</span>
<span id="cb5-318"><a href="#cb5-318" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-319"><a href="#cb5-319" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-320"><a href="#cb5-320" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Total allocation vs debit</span></span>
<span id="cb5-321"><a href="#cb5-321" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].plot(df[<span class="st">'debit'</span>], df[<span class="st">'allocation_pct'</span>], <span class="st">'g-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-322"><a href="#cb5-322" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].axhline(y<span class="op">=</span><span class="va">self</span>.allocation_fraction <span class="op">*</span> <span class="dv">100</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb5-323"><a href="#cb5-323" aria-hidden="true" tabindex="-1"></a>                          label<span class="op">=</span><span class="ss">f'Target: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>allocation_fraction<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%'</span>)</span>
<span id="cb5-324"><a href="#cb5-324" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Calendar Spread Debit ($)'</span>)</span>
<span id="cb5-325"><a href="#cb5-325" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Portfolio Allocation (%)'</span>)</span>
<span id="cb5-326"><a href="#cb5-326" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Actual vs Target Allocation'</span>)</span>
<span id="cb5-327"><a href="#cb5-327" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].legend()</span>
<span id="cb5-328"><a href="#cb5-328" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-329"><a href="#cb5-329" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-330"><a href="#cb5-330" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cost breakdown</span></span>
<span id="cb5-331"><a href="#cb5-331" aria-hidden="true" tabindex="-1"></a>        sample_debit <span class="op">=</span> debit_range[<span class="bu">len</span>(debit_range)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb5-332"><a href="#cb5-332" aria-hidden="true" tabindex="-1"></a>        sample_sizing <span class="op">=</span> <span class="va">self</span>.calculate_position_size(sample_debit)</span>
<span id="cb5-333"><a href="#cb5-333" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-334"><a href="#cb5-334" aria-hidden="true" tabindex="-1"></a>        costs <span class="op">=</span> [</span>
<span id="cb5-335"><a href="#cb5-335" aria-hidden="true" tabindex="-1"></a>            sample_debit <span class="op">*</span> <span class="dv">100</span>,  <span class="co"># Premium cost</span></span>
<span id="cb5-336"><a href="#cb5-336" aria-hidden="true" tabindex="-1"></a>            sample_sizing[<span class="st">'commission_per_contract'</span>],  <span class="co"># Commission</span></span>
<span id="cb5-337"><a href="#cb5-337" aria-hidden="true" tabindex="-1"></a>            sample_sizing[<span class="st">'slippage_estimate'</span>]  <span class="co"># Slippage</span></span>
<span id="cb5-338"><a href="#cb5-338" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb5-339"><a href="#cb5-339" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> [<span class="st">'Premium'</span>, <span class="st">'Commission'</span>, <span class="st">'Slippage'</span>]</span>
<span id="cb5-340"><a href="#cb5-340" aria-hidden="true" tabindex="-1"></a>        colors <span class="op">=</span> [<span class="st">'blue'</span>, <span class="st">'orange'</span>, <span class="st">'red'</span>]</span>
<span id="cb5-341"><a href="#cb5-341" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-342"><a href="#cb5-342" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].pie(costs, labels<span class="op">=</span>labels, colors<span class="op">=</span>colors, autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>, startangle<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb5-343"><a href="#cb5-343" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="ss">f'Cost Breakdown ($</span><span class="sc">{</span>sample_debit<span class="sc">:.2f}</span><span class="ss"> debit)'</span>)</span>
<span id="cb5-344"><a href="#cb5-344" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-345"><a href="#cb5-345" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Efficiency analysis</span></span>
<span id="cb5-346"><a href="#cb5-346" aria-hidden="true" tabindex="-1"></a>        efficiency_threshold <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Minimum contracts for efficiency</span></span>
<span id="cb5-347"><a href="#cb5-347" aria-hidden="true" tabindex="-1"></a>        efficient_mask <span class="op">=</span> df[<span class="st">'position_size'</span>] <span class="op">&gt;=</span> efficiency_threshold</span>
<span id="cb5-348"><a href="#cb5-348" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-349"><a href="#cb5-349" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].scatter(df.loc[efficient_mask, <span class="st">'debit'</span>], </span>
<span id="cb5-350"><a href="#cb5-350" aria-hidden="true" tabindex="-1"></a>                          df.loc[efficient_mask, <span class="st">'position_size'</span>], </span>
<span id="cb5-351"><a href="#cb5-351" aria-hidden="true" tabindex="-1"></a>                          color<span class="op">=</span><span class="st">'green'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Efficient'</span>)</span>
<span id="cb5-352"><a href="#cb5-352" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].scatter(df.loc[<span class="op">~</span>efficient_mask, <span class="st">'debit'</span>], </span>
<span id="cb5-353"><a href="#cb5-353" aria-hidden="true" tabindex="-1"></a>                          df.loc[<span class="op">~</span>efficient_mask, <span class="st">'position_size'</span>], </span>
<span id="cb5-354"><a href="#cb5-354" aria-hidden="true" tabindex="-1"></a>                          color<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Inefficient'</span>)</span>
<span id="cb5-355"><a href="#cb5-355" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].axhline(y<span class="op">=</span>efficiency_threshold, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb5-356"><a href="#cb5-356" aria-hidden="true" tabindex="-1"></a>                          label<span class="op">=</span><span class="ss">f'Efficiency Threshold: </span><span class="sc">{</span>efficiency_threshold<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-357"><a href="#cb5-357" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Calendar Spread Debit ($)'</span>)</span>
<span id="cb5-358"><a href="#cb5-358" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Position Size (Contracts)'</span>)</span>
<span id="cb5-359"><a href="#cb5-359" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Position Sizing Efficiency'</span>)</span>
<span id="cb5-360"><a href="#cb5-360" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].legend()</span>
<span id="cb5-361"><a href="#cb5-361" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-362"><a href="#cb5-362" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-363"><a href="#cb5-363" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb5-364"><a href="#cb5-364" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb5-365"><a href="#cb5-365" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-366"><a href="#cb5-366" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb5-367"><a href="#cb5-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-368"><a href="#cb5-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb5-369"><a href="#cb5-369" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb5-370"><a href="#cb5-370" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate sample returns data (volatility selling characteristics)</span></span>
<span id="cb5-371"><a href="#cb5-371" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb5-372"><a href="#cb5-372" aria-hidden="true" tabindex="-1"></a>    n_trades <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb5-373"><a href="#cb5-373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-374"><a href="#cb5-374" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate positive skew returns typical of volatility selling</span></span>
<span id="cb5-375"><a href="#cb5-375" aria-hidden="true" tabindex="-1"></a>    base_return <span class="op">=</span> <span class="fl">0.02</span>  <span class="co"># 2% average return</span></span>
<span id="cb5-376"><a href="#cb5-376" aria-hidden="true" tabindex="-1"></a>    vol <span class="op">=</span> <span class="fl">0.15</span>  <span class="co"># 15% volatility</span></span>
<span id="cb5-377"><a href="#cb5-377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-378"><a href="#cb5-378" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> np.random.normal(base_return, vol, n_trades)</span>
<span id="cb5-379"><a href="#cb5-379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-380"><a href="#cb5-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some tail losses (characteristic of volatility selling)</span></span>
<span id="cb5-381"><a href="#cb5-381" aria-hidden="true" tabindex="-1"></a>    tail_prob <span class="op">=</span> <span class="fl">0.05</span>  <span class="co"># 5% chance of tail event</span></span>
<span id="cb5-382"><a href="#cb5-382" aria-hidden="true" tabindex="-1"></a>    tail_events <span class="op">=</span> np.random.random(n_trades) <span class="op">&lt;</span> tail_prob</span>
<span id="cb5-383"><a href="#cb5-383" aria-hidden="true" tabindex="-1"></a>    returns[tail_events] <span class="op">=</span> np.random.normal(<span class="op">-</span><span class="fl">0.4</span>, <span class="fl">0.1</span>, np.<span class="bu">sum</span>(tail_events))</span>
<span id="cb5-384"><a href="#cb5-384" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-385"><a href="#cb5-385" aria-hidden="true" tabindex="-1"></a>    returns_series <span class="op">=</span> pd.Series(returns)</span>
<span id="cb5-386"><a href="#cb5-386" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-387"><a href="#cb5-387" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Kelly analysis</span></span>
<span id="cb5-388"><a href="#cb5-388" aria-hidden="true" tabindex="-1"></a>    kelly_optimizer <span class="op">=</span> KellyOptimizer(returns_series)</span>
<span id="cb5-389"><a href="#cb5-389" aria-hidden="true" tabindex="-1"></a>    empirical_kelly, simulation_results <span class="op">=</span> kelly_optimizer.plot_kelly_analysis()</span>
<span id="cb5-390"><a href="#cb5-390" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-391"><a href="#cb5-391" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Position sizing analysis</span></span>
<span id="cb5-392"><a href="#cb5-392" aria-hidden="true" tabindex="-1"></a>    portfolio_value <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb5-393"><a href="#cb5-393" aria-hidden="true" tabindex="-1"></a>    position_sizer <span class="op">=</span> SunnyPositionSizer(portfolio_value, allocation_fraction<span class="op">=</span><span class="fl">0.06</span>)</span>
<span id="cb5-394"><a href="#cb5-394" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-395"><a href="#cb5-395" aria-hidden="true" tabindex="-1"></a>    debit_range <span class="op">=</span> np.linspace(<span class="fl">0.5</span>, <span class="fl">5.0</span>, <span class="dv">50</span>)</span>
<span id="cb5-396"><a href="#cb5-396" aria-hidden="true" tabindex="-1"></a>    sizing_analysis <span class="op">=</span> position_sizer.plot_position_sizing_analysis(debit_range)</span>
<span id="cb5-397"><a href="#cb5-397" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-398"><a href="#cb5-398" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Recommended fractional Kelly: </span><span class="sc">{</span>empirical_kelly[<span class="st">'fractional_kelly'</span>]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb5-399"><a href="#cb5-399" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Current allocation setting: </span><span class="sc">{</span>position_sizer<span class="sc">.</span>allocation_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>